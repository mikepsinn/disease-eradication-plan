[build]
  # Build command - installs dependencies and builds the economics models site
  command = """
    # Function to log and exit on error
    error_exit() {
      echo "ERROR: $1" >&2
      exit 1
    }
    
    # Verify Python is available (installed by Netlify via runtime.txt)
    echo "=== Step 1: Verifying Python ==="
    python3 --version || python --version || error_exit "Python not available"
    
    # Install Quarto if not available
    echo "=== Step 2: Installing Quarto ==="
    if ! command -v quarto &> /dev/null; then
      echo "Quarto not found, installing..."
      QUARTO_VERSION="${QUARTO_VERSION:-1.5.57}"
      wget -q "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz" || error_exit "Failed to download Quarto"
      tar -xzf "quarto-${QUARTO_VERSION}-linux-amd64.tar.gz" || error_exit "Failed to extract Quarto"
      mkdir -p /opt/buildhome/.local/bin /opt/buildhome/.local/share
      cp -r "quarto-${QUARTO_VERSION}/bin"/* /opt/buildhome/.local/bin/ || error_exit "Failed to copy Quarto bin"
      cp -r "quarto-${QUARTO_VERSION}/share"/* /opt/buildhome/.local/share/ || error_exit "Failed to copy Quarto share"
      export PATH="/opt/buildhome/.local/bin:$PATH"
      rm -rf "quarto-${QUARTO_VERSION}" "quarto-${QUARTO_VERSION}-linux-amd64.tar.gz"
    fi
    quarto --version || error_exit "Quarto installation failed"
    
    # Install Python dependencies
    echo "=== Step 3: Installing Python dependencies ==="
    python3 -m pip install --upgrade pip --user || python -m pip install --upgrade pip --user || error_exit "Failed to upgrade pip"
    python3 -m pip install -r requirements.txt --user || python -m pip install -r requirements.txt --user || error_exit "Failed to install Python packages"
    
    # Install local dih_models package
    echo "=== Step 4: Installing local package ==="
    if [ -f "pyproject.toml" ]; then
      python3 -m pip install -e . --user || python -m pip install -e . --user || echo "Warning: Local package installation failed, continuing..."
    fi
    
    # Install Jupyter kernel
    echo "=== Step 5: Installing Jupyter kernel ==="
    python3 -m ipykernel install --user --name dih-project-kernel --display-name "DIH Project" || python -m ipykernel install --user --name dih-project-kernel --display-name "DIH Project" || error_exit "Failed to install Jupyter kernel"
    
    # Install Node dependencies
    echo "=== Step 6: Installing Node dependencies ==="
    pnpm install || error_exit "Failed to install Node packages"
    
    # Build the site using the render_html.py script (same as GitHub Actions)
    echo "=== Step 7: Building site with Quarto ==="
    cp _quarto-economics.yml _quarto.yml || error_exit "Failed to copy Quarto config"
    
    # Set environment variables for Quarto
    export QUARTO_PYTHON=$(python3 -c "import sys; print(sys.executable)" 2>/dev/null || python -c "import sys; print(sys.executable)" 2>/dev/null || echo "python3")
    export JUPYTER_PLATFORM_DIRS=1
    
    # Use render_html.py script (has better error handling and validation)
    echo "Starting Quarto render via render_html.py..."
    python3 tools/render_html.py --output-dir _site/economics --command "quarto render" --skip-post-validation --no-fail-on-warnings || error_exit "Quarto render failed"
    
    echo "=== Step 8: Verifying output ==="
    if [ -d "_site/economics" ]; then
      echo "Output directory found: _site/economics"
      ls -la _site/economics/ | head -10
      echo "Build completed successfully!"
    else
      error_exit "Output directory _site/economics not found"
    fi
  """

  # Directory to publish - matches output-dir in _quarto-economics.yml
  publish = "_site/economics"

  # Ignore builds if there are no relevant changes
  # Temporarily disabled to test Python fix
  # ignore = "git diff --quiet $CACHED_COMMIT_REF $COMMIT_REF ."

[build.environment]
  # Specify Node.js version for builds
  NODE_VERSION = "20"

  # Enable pnpm
  NPM_FLAGS = "--prefix=/dev/null"
  ENABLE_PNPM = "true"
  
  # Quarto version for manual installation (if plugin doesn't work)
  QUARTO_VERSION = "1.5.57"
  
  # Disable mise to use Netlify's native Python support
  # Python version is specified in .python-version file
  MISE_USE_LEGACY_VERSION_FILES = "false"

[build.processing]
  skip_processing = false

# Headers for security and caching
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"

[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Redirects for clean URLs
[[redirects]]
  from = "/index.html"
  to = "/"
  status = 301
  force = true

# 404 page
[[redirects]]
  from = "/*"
  to = "/404.html"
  status = 404

# Enable Pretty URLs (remove .html extension)
[build.processing.html]
  pretty_urls = true
