---
jupyter: python3
echo: false
---

```{python}
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path
import sys

# Find project root dynamically
project_root = Path.cwd()
if project_root.name != 'decentralized-institutes-of-health':
    while project_root.name != 'decentralized-institutes-of-health' and project_root.parent != project_root:
        project_root = project_root.parent
sys.path.insert(0, str(project_root))

# Import centralized style
from brain.figures._chart_style import setup_chart_style, add_watermark, clean_spines
from brain.figures._chart_style import COLOR_BLACK, COLOR_WHITE

setup_chart_style()

# ROI Data - includes 1% Treaty + DIH + dFDA which has infinite ROI (cost-negative)
# Using central/conservative estimates where ranges exist
interventions = {
    '1% Treaty + DIH + dFDA': {
        'roi': 50000,  # Using 50000 to represent "infinite" - make other bars look like 0
        'category': 'proposed',
        'note': 'Self-funded by military redirection',
        'label': '\u221E'  # Unicode infinity symbol
    },
    'Smallpox Eradication': {
        'roi': 280,  # Mid-point of 159:1 to 400:1
        'category': 'historical',
        'note': 'One-time historical achievement',
        'label': None
    },
    'Tobacco Control': {
        'roi': 100,  # Conservative from 20:1 to 1,057:1
        'category': 'current',
        'note': 'Highly variable by program',
        'label': None
    },
    'Childhood Vaccinations': {
        'roi': 13,  # Mid-point of 10:1 to 16:1
        'category': 'current',
        'note': 'US programs',
        'label': None
    },
    'Clean Water & Sanitation': {
        'roi': 12,  # Mid-point of 4:1 to 21:1
        'category': 'current',
        'note': 'Low/middle-income countries',
        'label': None
    },
    'Statins (High-Risk)': {
        'roi': 3,  # From intervention table
        'category': 'current',
        'note': 'Pharmaceutical intervention',
        'label': None
    }
}

# Create figure - adjusted for tighter layout
fig, ax = plt.subplots(figsize=(14, 8))

# Prepare data
names = list(interventions.keys())
rois = [interventions[name]['roi'] for name in names]
categories = [interventions[name]['category'] for name in names]

# Define colors and patterns for categories
category_styles = {
    'proposed': {'color': COLOR_WHITE, 'hatch': '///', 'edge': COLOR_BLACK},
    'historical': {'color': COLOR_WHITE, 'hatch': '...', 'edge': COLOR_BLACK},
    'current': {'color': COLOR_WHITE, 'hatch': '', 'edge': COLOR_BLACK}
}

# Create bars
x_pos = np.arange(len(names))
bars = []
for i, (name, roi, cat) in enumerate(zip(names, rois, categories)):
    style = category_styles[cat]
    bar = ax.bar(x_pos[i], roi, width=0.7,
                 color=style['color'], edgecolor=style['edge'],
                 linewidth=2, hatch=style['hatch'])
    bars.append(bar)

    # Combine name and value into single label
    label = interventions[name].get('label')
    if label:
        # Place intervention name at top of bar
        name_lines = name.replace(' ', '\n')
        ax.text(x_pos[i], roi * 0.65,
                name_lines,
                ha='center', va='center',
                fontsize=24, color=COLOR_BLACK, weight='bold',
                linespacing=1.1)
        # Place dollar sign and infinity symbol separately for better control
        ax.text(x_pos[i] - 0.09, roi * 0.35,
                '$',
                ha='right', va='center',
                fontsize=50, color=COLOR_BLACK, weight='bold')
        ax.text(x_pos[i] - 0.15, roi * 0.35,
                label,
                ha='left', va='center',
                fontsize=80, color=COLOR_BLACK, weight='bold',
                family='DejaVu Sans')
    else:
        # For small bars, combine name and dollar value into one label
        # Place near the bottom since bars are essentially invisible
        name_lines = name.replace(' ', '\n')
        combined_label = f'{name_lines}\n${roi}'
        ax.text(x_pos[i], 800,
                combined_label,
                ha='center', va='bottom',
                fontsize=14, color=COLOR_BLACK, weight='bold',
                linespacing=1.1)

# Axis formatting - remove both x-axis and y-axis
ax.set_ylabel('')
ax.set_xlabel('')
ax.set_xticks([])  # Remove x-axis ticks and labels
ax.set_yticks([])  # Remove y-axis ticks

# Y-axis formatting - make infinity bar dominate, other bars should be invisible
ax.set_ylim(-500, max(rois) * 1.05)

# Title - positioned higher to avoid overlap with labels
ax.set_title('When Self-Funded by 1% Military Redirection: Infinite ROI',
            fontsize=24, color=COLOR_BLACK, weight='bold', pad=15, y=0.98)


# Add explanatory callout with inline LaTeX equation - positioned to the right
callout_text = r'The 1% Treaty redirects military spending to fund DIH + dFDA at zero net cost to society.' + '\n\n' + r'$\mathrm{ROI} = \frac{\$147\mathrm{B}}{\$0} = \infty$' + '\n\n' + 'Result: $147B in annual benefits (peace dividend + R&D savings)\nwith zero new spending = infinite ROI.\n\nThis is a "dominant intervention" - it saves money while saving lives.\n\nOther health interventions (shown for comparison) are invisible at this scale.'
ax.text(0.62, 0.50, callout_text,
        transform=ax.transAxes, ha='center', va='center',
        fontsize=15, color=COLOR_BLACK,
        bbox=dict(boxstyle='round,pad=1.0', facecolor=COLOR_WHITE,
                  edgecolor=COLOR_BLACK, linewidth=2, alpha=0.98),
        linespacing=1.4)

# Clean spines - remove all spines since no axes
clean_spines(ax, ['top', 'right', 'left', 'bottom'])

# Add watermark
add_watermark(fig)

# Save figure with tight bbox to minimize whitespace
output_dir = project_root / 'brain' / 'figures'
output_dir.mkdir(parents=True, exist_ok=True)
plt.savefig(output_dir / 'treaty-dih-dfda-roi-comparison-column-chart.png',
            dpi=200, bbox_inches=None, pad_inches=0.1, facecolor=COLOR_WHITE)

plt.show()
```