```{python}
#| label: stupidity-budget-progression
#| fig-cap: "The Three Stages of Realizing How Stupid We Are"

import sys
import os
from pathlib import Path

# Add project root to path (find it relative to current working directory)
project_root = Path.cwd()
if project_root.name != 'decentralized-institutes-of-health':
    while project_root.name != 'decentralized-institutes-of-health' and project_root.parent != project_root:
        project_root = project_root.parent
sys.path.insert(0, str(project_root))

import matplotlib.pyplot as plt
import numpy as np
from brain.figures._chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_RED, COLOR_BLUE, COLOR_WHITE,
    get_presentation_font_sizes
)

# Setup styling
setup_chart_style(style='light', dpi=150)
FONT_SIZES = get_presentation_font_sizes()

# Create figure with 3 subplots side by side
fig, (ax1, ax2, ax3) = plt.subplots(1, 3, figsize=(36, 12))

# ============================================================================
# CHART 1: Direct Spending Only - "You think that's bad?"
# ============================================================================

categories1 = ['War &\nMilitary', 'Curing\nCancer', 'Curing\nDementia']
values1 = [2720, 11, 5.5]  # All in billions
colors1 = [COLOR_RED, COLOR_BLUE, COLOR_BLUE]

bars1 = ax1.bar(categories1, values1, color=colors1, edgecolor=COLOR_WHITE, linewidth=3)

# Labels - no decimals
labels1 = ['$3T', '$11B', '$6B']
for bar, label, value in zip(bars1, labels1, values1):
    height = bar.get_height()
    if value > 1000:
        y_pos = height * 0.95
        va = 'top'
        color = COLOR_WHITE
        size = 48
    else:
        y_pos = height + (max(values1) * 0.02)
        va = 'bottom'
        color = COLOR_BLACK
        size = 40
    ax1.text(bar.get_x() + bar.get_width()/2., y_pos,
            label, ha='center', va=va, fontsize=size, weight='bold', color=color)

ax1.set_ylabel('Annual Spending (Billions)', fontsize=36, weight='bold', color=COLOR_BLACK)
ax1.set_title('Direct Spending\n"You think that\'s bad?"', fontsize=48, pad=30, weight='bold', color=COLOR_BLACK)
ax1.tick_params(axis='x', labelsize=32, colors=COLOR_BLACK)
ax1.tick_params(axis='y', labelsize=28, colors=COLOR_BLACK)
ax1.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1000:.0f}T' if x >= 1000 else f'{x:.0f}B'))
clean_spines(ax1, ['top', 'right'])
# Remove gridlines for cleaner look
# ax1.grid(True, alpha=0.3, color=COLOR_BLACK, axis='y')

# ============================================================================
# CHART 2: War Externalities Stacked - "Here's what that $2.7T ACTUALLY buys"
# ============================================================================

categories2 = ['War &\nMilitary\n(Total Cost)', 'Curing\nCancer', 'Curing\nDementia']

# War costs breakdown (from cost-of-war.qmd)
war_direct = 2720  # Direct military spending
war_infrastructure = 1875  # Infrastructure destruction
war_lives = 1000  # Human life losses
war_trade = 616  # Trade disruption
war_indirect = 3538  # Lost growth, veterans, refugees, environment, etc.

# Total war cost = $9,747B
war_total = war_direct + war_infrastructure + war_lives + war_trade + war_indirect

# Stacked values for war column
war_stack = [war_direct, war_infrastructure, war_lives + war_trade, war_indirect]
cure_values = [11, 5.5]  # Cancer and dementia research

# Use single RED color for all war costs (problem)
war_color = COLOR_RED

# Plot stacked bar for war
bottom = 0
war_bars = []
for i, value in enumerate(war_stack):
    bar = ax2.bar(0, value, bottom=bottom, color=war_color, edgecolor=COLOR_WHITE, linewidth=2, width=0.8)
    war_bars.append(bar)

    # Add labels for each segment - no decimals
    label_y = bottom + value/2
    if i == 0:
        label_text = f'Direct: ${war_direct/1000:.1f}T'
    elif i == 1:
        label_text = f'Infrastructure: ${war_infrastructure/1000:.0f}T'
    elif i == 2:
        label_text = f'Lives + Trade: ${(war_lives + war_trade)/1000:.0f}T'
    else:
        label_text = f'Indirect: ${war_indirect/1000:.0f}T'

    ax2.text(0, label_y, label_text, ha='center', va='center',
            fontsize=28, weight='bold', color=COLOR_WHITE)
    bottom += value

# Plot cure bars
ax2.bar(1, cure_values[0], color=COLOR_BLUE, edgecolor=COLOR_WHITE, linewidth=3, width=0.8)
ax2.bar(2, cure_values[1], color=COLOR_BLUE, edgecolor=COLOR_WHITE, linewidth=3, width=0.8)

# Labels for cures
ax2.text(1, cure_values[0] + (war_total * 0.02), '$11B', ha='center', va='bottom',
        fontsize=40, weight='bold', color=COLOR_BLACK)
ax2.text(2, cure_values[1] + (war_total * 0.02), '$6B', ha='center', va='bottom',
        fontsize=40, weight='bold', color=COLOR_BLACK)

# Total label on war stack - no decimal
ax2.text(0, war_total * 1.02, f'$10T TOTAL', ha='center', va='bottom',
        fontsize=48, weight='bold', color=COLOR_RED)

ax2.set_xticks([0, 1, 2])
ax2.set_xticklabels(categories2)
ax2.set_ylabel('Annual Cost (Billions)', fontsize=36, weight='bold', color=COLOR_BLACK)
ax2.set_title('True War Costs\n"Here\'s what that $2.7T ACTUALLY buys"', fontsize=48, pad=30, weight='bold', color=COLOR_BLACK)
ax2.tick_params(axis='x', labelsize=32, colors=COLOR_BLACK)
ax2.tick_params(axis='y', labelsize=28, colors=COLOR_BLACK)
ax2.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1000:.0f}T' if x >= 1000 else f'{x:.0f}B'))
clean_spines(ax2, ['top', 'right'])
# Remove gridlines for cleaner look
# ax2.grid(True, alpha=0.3, color=COLOR_BLACK, axis='y')

# ============================================================================
# CHART 3: Add Disease Costs - "And here's what we're NOT curing"
# ============================================================================

categories3 = ['War\n(Total)', 'Disease\n(Total)', 'Curing\nCancer', 'Curing\nDementia']

# Disease costs breakdown (from cost-of-disease.qmd)
disease_medical = 9900  # Direct medical costs
disease_productivity = 5000  # Lost productivity
disease_lives = 94200  # Lost human life (DALYs)
disease_total = disease_medical + disease_productivity + disease_lives  # $109.1T

# Stacked values for disease
disease_stack = [disease_medical, disease_productivity, disease_lives]

# Use single RED color for all disease costs (problem)
disease_color = COLOR_RED

# Plot war total
ax3.bar(0, war_total, color=COLOR_RED, edgecolor=COLOR_WHITE, linewidth=3, width=0.8)
ax3.text(0, war_total * 0.5, f'$10T', ha='center', va='center',
        fontsize=42, weight='bold', color=COLOR_WHITE)

# Plot stacked disease bar
bottom = 0
disease_bars = []
for i, value in enumerate(disease_stack):
    bar = ax3.bar(1, value, bottom=bottom, color=disease_color, edgecolor=COLOR_WHITE, linewidth=2, width=0.8)
    disease_bars.append(bar)

    # Add labels for each segment - no decimals
    label_y = bottom + value/2
    if i == 0:
        label_text = f'Medical: ${disease_medical/1000:.0f}T'
    elif i == 1:
        label_text = f'Lost Work: ${disease_productivity/1000:.0f}T'
    else:
        label_text = f'Lost Lives: ${disease_lives/1000:.0f}T'

    ax3.text(1, label_y, label_text, ha='center', va='center',
            fontsize=28, weight='bold', color=COLOR_WHITE)
    bottom += value

# Total label on disease stack
ax3.text(1, disease_total * 1.02, f'$109T TOTAL', ha='center', va='bottom',
        fontsize=52, weight='bold', color=COLOR_RED)

# Plot cure bars (tiny compared to disease)
ax3.bar(2, cure_values[0], color=COLOR_BLUE, edgecolor=COLOR_WHITE, linewidth=3, width=0.8)
ax3.bar(3, cure_values[1], color=COLOR_BLUE, edgecolor=COLOR_WHITE, linewidth=3, width=0.8)

# Labels for cures
ax3.text(2, cure_values[0] + (disease_total * 0.01), '$11B', ha='center', va='bottom',
        fontsize=40, weight='bold', color=COLOR_BLACK)
ax3.text(3, cure_values[1] + (disease_total * 0.01), '$6B', ha='center', va='bottom',
        fontsize=40, weight='bold', color=COLOR_BLACK)

ax3.set_xticks([0, 1, 2, 3])
ax3.set_xticklabels(categories3)
ax3.set_ylabel('Annual Cost (Billions)', fontsize=36, weight='bold', color=COLOR_BLACK)
ax3.set_title('The Full Picture\n"And here\'s what we\'re NOT curing"', fontsize=48, pad=30, weight='bold', color=COLOR_BLACK)
ax3.tick_params(axis='x', labelsize=32, colors=COLOR_BLACK)
ax3.tick_params(axis='y', labelsize=28, colors=COLOR_BLACK)
ax3.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1000:.0f}T' if x >= 1000 else f'{x:.0f}B'))
clean_spines(ax3, ['top', 'right'])
# Remove gridlines for cleaner look
# ax3.grid(True, alpha=0.3, color=COLOR_BLACK, axis='y')

# Add watermark
add_watermark(fig)

# Don't use tight_layout - it overrides margins
# plt.tight_layout()

# Save in brain/charts directory
output_dir = project_root / 'brain' / 'charts'
output_dir.mkdir(parents=True, exist_ok=True)
plt.savefig(output_dir / 'stupidity-budget-progression.png', dpi=200, bbox_inches=None, facecolor=COLOR_WHITE)
plt.show()
```
