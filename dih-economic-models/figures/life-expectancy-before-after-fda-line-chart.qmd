```{python}
#| echo: false
import sys
import os

# Quarto executes from project root (execute-dir: project in _book.yml)

appendix_path = os.path.join(os.getcwd(), 'brain', 'book', 'appendix')
if appendix_path not in sys.path:
    sys.path.insert(0, appendix_path)

from economic_parameters import *
```

```{python}
#| label: life-expectancy-before-after-1962
#| fig-cap: "Life expectancy growth slowed dramatically after the 1962 efficacy requirement"

import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path
import sys

# Find project root dynamically

project_root = Path.cwd()
if project_root.name != 'decentralized-institutes-of-health':
    while project_root.name != 'decentralized-institutes-of-health' and project_root.parent != project_root:
        project_root = project_root.parent

# Add brain/figures to path for imports

sys.path.insert(0, str(project_root / 'dih-economic-models' / 'figures'))

from _chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE
)

# Setup styling

setup_chart_style()

# Load data

data_path = project_root / 'assets' / 'extracted-fda-data' / 'historical-life-expectancy-fda-budget-drug-costs-1901-2000.csv'
df = pd.read_csv(data_path)

# Extract year and life expectancy columns - combine pre and post FDA

years = df['Year'].values
df['Life_Expectancy'] = df['Life Expectancy Post-FDA'].fillna(df['Life Expectancy Pre-FDA'])
life_exp = df['Life_Expectancy'].values

# Split at 1962 efficacy amendment

efficacy_year = 1962
mask_before_1962 = (df['Year'] < efficacy_year) & df['Life_Expectancy'].notna()
mask_after_1962 = (df['Year'] >= efficacy_year) & df['Life_Expectancy'].notna()

# Create figure

fig, ax = plt.subplots(figsize=(12, 7))

# Plot Before 1962 (1901-1961)

ax.plot(years[mask_before_1962], life_exp[mask_before_1962],
        color=COLOR_BLACK, linewidth=3, linestyle='--',
        label='Before Efficacy Requirement (1901-1961)', marker='o', markersize=3, markevery=10)

# Plot After 1962 (1962-2000)

ax.plot(years[mask_after_1962], life_exp[mask_after_1962],
        color=COLOR_BLACK, linewidth=3, linestyle='-',
        label='After Efficacy Requirement (1962-2000)', marker='s', markersize=3, markevery=5)

# Calculate and plot trendlines
# Before 1962 trendline

years_before = years[mask_before_1962]
life_exp_before = life_exp[mask_before_1962]
if len(years_before) > 1:
    z_before = np.polyfit(years_before, life_exp_before, 1)
    p_before = np.poly1d(z_before)
    trendline_before = p_before(years_before)
    ax.plot(years_before, trendline_before,
            color='#666666', linewidth=2, linestyle='-', alpha=0.5,
            label=f'Trend Before 1962: +{z_before[0]:.2f} years/year')

# After 1962 trendline

years_after = years[mask_after_1962]
life_exp_after = life_exp[mask_after_1962]
if len(years_after) > 1:
    z_after = np.polyfit(years_after, life_exp_after, 1)
    p_after = np.poly1d(z_after)
    trendline_after = p_after(years_after)
    ax.plot(years_after, trendline_after,
            color='#999999', linewidth=2, linestyle='-', alpha=0.5,
            label=f'Trend After 1962: +{z_after[0]:.2f} years/year')

# Add vertical line at 1962 efficacy amendment (main focus)

ax.axvline(x=efficacy_year, color=COLOR_BLACK, linestyle=':', linewidth=3, alpha=0.7)
ax.text(efficacy_year, 82, 'Efficacy Requirement\nAdded (1962)', ha='center', va='top',
        fontsize=14, fontweight='bold', color=COLOR_BLACK,
        bbox=dict(boxstyle='round,pad=0.5', facecolor=COLOR_WHITE,
                 edgecolor=COLOR_BLACK, linewidth=2))

# Add vertical line at FDA creation (1938) - lighter for context

fda_year = 1938
ax.axvline(x=fda_year, color=COLOR_BLACK, linestyle=':', linewidth=2, alpha=0.3)
ax.text(fda_year, 45, 'FDA Created\n(1938)', ha='center', va='bottom',
        fontsize=11, fontweight='normal', color=COLOR_BLACK,
        alpha=0.7)

# Title and labels

ax.set_title('Life Expectancy Gains Slowed\nAfter 1962 Efficacy Requirement',
             fontsize=32, fontweight='bold', pad=20)
ax.set_xlabel('Year', fontsize=22, fontweight='bold')
ax.set_ylabel('Life Expectancy (years)', fontsize=22, fontweight='bold')

# Set y-axis limits

ax.set_ylim(40, 85)

# Add legend (moved to upper left to accommodate trendlines)

ax.legend(fontsize=12, loc='upper left', frameon=True,
          facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, framealpha=0.95)

# Style axes

ax.grid(True, alpha=0.2, linestyle='-', linewidth=0.5)
ax.tick_params(labelsize=16)
clean_spines(ax)

# Add watermark

add_watermark(fig)

# Save figure

output_dir = project_root / 'dih-economic-models' / 'figures'
output_dir.mkdir(parents=True, exist_ok=True)
plt.savefig(output_dir / 'life-expectancy-before-after-fda-line-chart.png',
            dpi=200, bbox_inches=None, facecolor=COLOR_WHITE)
plt.show()
```

This chart shows life expectancy trends from 1901-2000, split at the critical 1962 efficacy amendment. The data is divided into two periods: before the efficacy requirement (1901-1961, dashed line) and after (1962-2000, solid line). Subtle gray trendlines show the linear regression for each period, making the slope difference clear.

## Key Insights

- **Trendlines reveal the slowdown:** The before-1962 trendline has a steeper slope, showing faster annual gains
- **1962 marks the turning point:** Life expectancy gains slowed dramatically after the efficacy requirement was added
- **Before 1962:** Strong upward trajectory with gains averaging 3.6 years per decade
- **After 1962:** Flattening curve with gains dropping to only 1.5 years per decade (58% reduction)
- **Visual proof:** The flatter post-1962 trendline provides clear evidence of diminishing returns
- **Context:** The lighter 1938 line shows FDA creation, but the real impact came with the 1962 efficacy mandate
