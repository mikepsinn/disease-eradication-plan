```{python}
#| echo: false
from dih_models.parameters import *
```

```{python}
#| echo: false
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.graph_objects as go
import plotly.express as px

# Set style

plt.style.use('seaborn-v0_8-darkgrid')
sns.set_palette("husl")
```

## dFDA Infrastructure Economics

### Key Metrics

```{python}
#| echo: false
# Core economic metrics from analysis

metrics = {
    'ROI Ratio': float(TREATY_COMPLETE_ROI_ALL_BENEFITS),  # PRIMARY: Complete benefits including disease eradication delay
    'Annual R&D Savings (Billions)': float(DFDA_RD_GROSS_SAVINGS_ANNUAL) / 1_000_000_000,
    'Annual QALYs Generated': float(DFDA_QALYS_RD_PLUS_DELAY_ANNUAL),
    'Daily Opportunity Cost (Millions)': float(DFDA_RD_GROSS_SAVINGS_ANNUAL) / 365 / 1_000_000,
    'ICER per QALY': float(DFDA_ICER_PER_QALY),
    'Per-Patient Cost Reduction': float(TRADITIONAL_PHASE3_COST_PER_PATIENT) / float(RECOVERY_TRIAL_COST_PER_PATIENT),
    'Platform Annual Cost (Millions)': float(DFDA_ANNUAL_OPEX) / 1_000_000
}

# Create interactive key metrics display

fig = go.Figure()

# Add metric cards

metric_names = list(metrics.keys())
metric_values = list(metrics.values())

# Format values for display

formatted_values = []
for name, value in metrics.items():
    if 'Billions' in name:
        formatted_values.append(f'${value}B')
    elif 'Millions' in name:
        formatted_values.append(f'${value}M')
    elif 'ROI' in name:
        formatted_values.append(f'{value}:1')
    elif 'QALY' in name and 'ICER' not in name:
        formatted_values.append(f'{value:,}')
    elif 'ICER' in name:
        formatted_values.append(f'${value:,}')
    elif 'Reduction' in name:
        formatted_values.append(f'{value}x')
    else:
        formatted_values.append(str(value))

# Create subplot with metric cards

fig = go.Figure()

for i, (name, value) in enumerate(zip(metric_names, formatted_values)):
    color = px.colors.qualitative.Plotly[i % len(px.colors.qualitative.Plotly)]

    fig.add_trace(go.Indicator(
        mode = "number",
        value = metrics[name] if not isinstance(metrics[name], str) else 0,
        number = {'font': {'size': 40, 'color': color}, 'prefix': '', 'suffix': ''},
        title = {'text': f"<b>{name}</b><br><span style='font-size:30px'>{value}</span>",
                'font': {'size': 16}},
        domain = {'row': i // 2, 'column': i % 2}
    ))

fig.update_layout(
    title="dFDA Infrastructure: Key Economic Metrics",
    grid={'rows': 4, 'columns': 2, 'pattern': "independent"},
    height=800,
    showlegend=False
)

fig.show()
```

### Cost Reduction Scenarios

```{python}
#| echo: false
# Cost reduction scenarios from the analysis

scenarios = pd.DataFrame({
    'Scenario': ['Conservative', 'Base Case', 'Optimistic', 'Transformative'],
    'Cost Reduction %': [30, 50, 70, 95],
    'Annual Savings (Billions)': [30, 50, 70, 95]
})

# Create waterfall chart showing progression of savings

fig = go.Figure(go.Waterfall(
    name = "Cost Savings",
    orientation = "v",
    measure = ["relative", "relative", "relative", "total"],
    x = scenarios['Scenario'],
    textposition = "outside",
    text = [f"${x}B" for x in scenarios['Annual Savings (Billions)']],
    y = [30, 20, 20, 25],  # Incremental values
    connector = {"line":{"color":"rgb(63, 63, 63)"}},
    increasing = {"marker":{"color":"green"}},
    decreasing = {"marker":{"color":"red"}},
    totals = {"marker":{"color":"blue"}}
))

fig.update_layout(
    title = "Annual R&D Savings by Cost Reduction Scenario",
    xaxis_title = "Scenario",
    yaxis_title = "Annual Savings ($ Billions)",
    showlegend = False,
    height=500
)

fig.show()
```

### ROI Sensitivity Analysis

```{python}
#| echo: false
# ROI ranges based on current sensitivity scenarios from parameters.py

roi_data = pd.DataFrame({
    'Cost Scenario': ['Optimistic', 'Baseline', 'Conservative'],
    'Annual Platform Cost (Millions)': [
        float(SENSITIVITY_DFDA_OPEX_OPTIMISTIC) / 1_000_000,
        float(DFDA_ANNUAL_OPEX) / 1_000_000,
        float(SENSITIVITY_DFDA_OPEX_CONSERVATIVE) / 1_000_000
    ],
    'ROI Ratio': [
        float(TREATY_OPTIMISTIC_SCENARIO_ROI),
        float(TREATY_COMPLETE_ROI_ALL_BENEFITS),  # PRIMARY: full health benefits
        float(TREATY_CONSERVATIVE_SCENARIO_ROI)
    ]
})

# Create bar chart

fig = go.Figure()

# Add ROI bars

fig.add_trace(go.Bar(
    name='ROI Ratio',
    x=roi_data['Cost Scenario'],
    y=roi_data['ROI Ratio'],
    marker_color='lightblue',
    text=[f'{x:.0f}:1' for x in roi_data['ROI Ratio']],
    textposition='auto',
))

# Add cost labels
for i, row in roi_data.iterrows():
    fig.add_annotation(
        x=row['Cost Scenario'],
        y=row['ROI Ratio'],
        text=f"${row['Annual Platform Cost (Millions)']:.0f}M/yr",
        showarrow=False,
        yshift=20,
        font=dict(size=10, color='darkgreen')
    )

fig.update_layout(
    title='ROI Sensitivity to Platform Cost Scenarios',
    xaxis_title='Cost Scenario',
    yaxis_title='ROI Ratio',
    hovermode='x unified',
    height=500,
    showlegend=False
)

fig.show()
```

### Per-Patient Cost Comparison

```{python}
#| echo: false
# Per-patient trial costs comparison - using current parameters

traditional_cost = float(TRADITIONAL_PHASE3_COST_PER_PATIENT)
recovery_cost = float(RECOVERY_TRIAL_COST_PER_PATIENT)

cost_comparison = pd.DataFrame({
    'Trial Type': ['Traditional Phase III', 'RECOVERY Trial Model'],
    'Cost per Patient': [traditional_cost, recovery_cost],
    'Reduction Factor': [1, traditional_cost / recovery_cost]
})

# Create bar chart with cost reduction factors

fig = go.Figure()

colors = ['red', 'orange', 'lightgreen', 'darkgreen']
fig.add_trace(go.Bar(
    x=cost_comparison['Trial Type'],
    y=cost_comparison['Cost per Patient'],
    marker_color=colors,
    text=[f'${x:,}<br>{r}x reduction' if r > 1 else f'${x:,}<br>baseline'
          for x, r in zip(cost_comparison['Cost per Patient'],
                         cost_comparison['Reduction Factor'])],
    textposition='auto',
))

fig.update_layout(
    title='Per-Patient Clinical Trial Cost Comparison',
    xaxis_title='Trial Type',
    yaxis_title='Cost per Patient ($)',
    yaxis_type='log',
    showlegend=False,
    height=500
)

fig.show()
```

### Daily Opportunity Cost Counter

```{python}
#| echo: false
# Daily opportunity cost breakdown

daily_costs = pd.DataFrame({
    'Category': ['Economic Waste', 'Lost QALYs Value', 'Delayed Innovation',
                 'Preventable Deaths Cost'],
    'Daily Cost (Millions)': [137, 345, 68, 27],
    'Annual Cost (Billions)': [50, 126, 25, 10]
})

# Create stacked area chart showing cumulative daily cost

days = np.arange(1, 366)
cumulative_costs = pd.DataFrame({
    'Day': days,
    'Economic Waste': days * 137,
    'Lost QALYs Value': days * 345,
    'Delayed Innovation': days * 68,
    'Preventable Deaths': days * 27
})

fig = go.Figure()

for column in ['Preventable Deaths', 'Delayed Innovation', 'Lost QALYs Value', 'Economic Waste']:
    fig.add_trace(go.Scatter(
        x=cumulative_costs['Day'],
        y=cumulative_costs[column],
        mode='lines',
        name=column,
        stackgroup='one',
        fillcolor=px.colors.qualitative.Pastel[
            ['Economic Waste', 'Lost QALYs Value', 'Delayed Innovation', 'Preventable Deaths'].index(column)
        ]
    ))

fig.update_layout(
    title='Cumulative Opportunity Cost of Inaction (1 Year)',
    xaxis_title='Days',
    yaxis_title='Cumulative Cost ($ Millions)',
    hovermode='x unified',
    height=500,
    showlegend=True,
    legend=dict(x=0.02, y=0.98)
)

# Add annotation for total annual cost

fig.add_annotation(
    x=365, y=sum(cumulative_costs.iloc[-1][1:]),
    text=f"Total Annual Cost: ${sum(daily_costs['Annual Cost (Billions)'])}B",
    showarrow=True,
    arrowhead=2,
    bgcolor="white",
    bordercolor="black",
    borderwidth=1
)

fig.show()
```

### Investment vs Returns Timeline

```{python}
#| echo: false
# 10-year investment vs returns projection

years = np.arange(0, 11)
platform_costs = np.array([40] + [40]*10)  # Initial + annual costs
cumulative_costs = np.cumsum(platform_costs)
annual_savings = np.array([0] + [50000]*10)  # No savings in year 0
cumulative_savings = np.cumsum(annual_savings)
net_benefit = cumulative_savings - cumulative_costs

timeline_data = pd.DataFrame({
    'Year': years,
    'Cumulative Investment': cumulative_costs,
    'Cumulative Savings': cumulative_savings,
    'Net Benefit': net_benefit
})

# Create line chart

fig = go.Figure()

fig.add_trace(go.Scatter(
    x=timeline_data['Year'],
    y=timeline_data['Cumulative Investment'],
    mode='lines+markers',
    name='Cumulative Investment',
    line=dict(color='red', width=3),
    marker=dict(size=8)
))

fig.add_trace(go.Scatter(
    x=timeline_data['Year'],
    y=timeline_data['Cumulative Savings'],
    mode='lines+markers',
    name='Cumulative Savings',
    line=dict(color='green', width=3),
    marker=dict(size=8)
))

fig.add_trace(go.Scatter(
    x=timeline_data['Year'],
    y=timeline_data['Net Benefit'],
    mode='lines+markers',
    name='Net Benefit',
    line=dict(color='blue', width=3, dash='dash'),
    marker=dict(size=8)
))

# Add break-even point

break_even_year = 1  # Platform pays for itself after year 1
fig.add_vline(x=break_even_year, line_dash="dot", line_color="gray",
              annotation_text="Break-even", annotation_position="top")

fig.update_layout(
    title='dFDA Infrastructure: 10-Year Investment vs Returns',
    xaxis_title='Year',
    yaxis_title='Amount ($ Millions)',
    hovermode='x unified',
    height=500,
    showlegend=True,
    legend=dict(x=0.02, y=0.98)
)

# Add ROI annotation at year 10

fig.add_annotation(
    x=10, y=net_benefit[10],
    text=f"10-Year ROI: {float(TREATY_COMPLETE_ROI_ALL_BENEFITS):.0f}:1<br>NPV: ${net_benefit[10]/1000:.1f}B",
    showarrow=True,
    arrowhead=2,
    bgcolor="lightblue",
    bordercolor="blue",
    borderwidth=2
)

fig.show()
```

## Usage Instructions

This file contains reusable chart components for the dFDA economic analysis. To use these charts in other documents:

1. **Include specific charts**: Use Quarto's chunk options to include individual charts
2. **Modify data**: Update the dataframes in each chunk to reflect new calculations
3. **Export static images**: Charts can be saved as PNG/SVG for presentations

### Key Data Sources

- **ROI Calculation**: Based on annual cost generating R&D savings and regulatory delay elimination benefits
- **QALY Impact**: {{< var dfda_qalys_rd_plus_delay_annual >}} annual QALYs from eliminating 7.2-year regulatory efficacy lag
- **Cost Reductions**: 80-160x per-patient cost reduction vs traditional trials
- **Daily Opportunity Cost**: $137M economic + 203,145 QALYs lost daily

All figures derived from [Regulatory Mortality Analysis](../appendix/regulatory-mortality-analysis.qmd) and [dFDA Cost-Benefit Analysis](../appendix/dfda-cost-benefit-analysis.qmd).
