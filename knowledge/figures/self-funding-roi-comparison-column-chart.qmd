{{< include /knowledge/includes/setup-parameters.qmd >}}

```{python}
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

# Find project root dynamically

# Import centralized style

from dih_models.plotting.chart_style import setup_chart_style, add_watermark, clean_spines
from dih_models.plotting.chart_style import COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
from dih_models.parameters import format_parameter_value

setup_chart_style()

# ROI Data - includes a 1% Treaty-funded health framework which has infinite ROI (cost-negative)
# Using central/conservative estimates where ranges exist

interventions = {
    'Treaty-\nFunded\nPragmatic\nTrials': {
        'roi': 50000,  # Using 50000 to represent "infinite" - make other bars look like 0
        'category': 'proposed',
        'note': 'Self-funded by military redirection',
        'label': '\u221E'  # Unicode infinity symbol
    },
    'Smallpox Eradication': {
        'roi': float(SMALLPOX_ERADICATION_ROI),
        'category': 'historical',
        'note': 'One-time historical achievement',
        'label': None
    },
    'Tobacco Control': {
        'roi': 100,  # Conservative from 20:1 to 1,057:1 (no parameter exists)
        'category': 'current',
        'note': 'Highly variable by program',
        'label': None
    },
    'Childhood Vaccinations': {
        'roi': float(CHILDHOOD_VACCINATION_ROI),
        'category': 'current',
        'note': 'US programs',
        'label': None
    },
    'Clean Water & Sanitation': {
        'roi': float(WATER_FLUORIDATION_ROI),
        'category': 'current',
        'note': 'Low/middle-income countries',
        'label': None
    },
    'Statins (High-Risk)': {
        'roi': 3,  # From intervention table (no parameter exists)
        'category': 'current',
        'note': 'Pharmaceutical intervention',
        'label': None
    }
}

# Create figure - adjusted for tighter layout

fig, ax = plt.subplots(figsize=(14, 8))

# Prepare data

names = list(interventions.keys())
rois = [interventions[name]['roi'] for name in names]
categories = [interventions[name]['category'] for name in names]

# Define colors and patterns for categories

category_styles = {
    'proposed': {'color': COLOR_WHITE, 'hatch': '///', 'edge': COLOR_BLACK},
    'historical': {'color': COLOR_WHITE, 'hatch': '...', 'edge': COLOR_BLACK},
    'current': {'color': COLOR_WHITE, 'hatch': '', 'edge': COLOR_BLACK}
}

# Create bars

x_pos = np.arange(len(names))
bars = []
for i, (name, roi, cat) in enumerate(zip(names, rois, categories)):
    style = category_styles[cat]
    bar = ax.bar(x_pos[i], roi, width=0.7,
                 color=style['color'], edgecolor=style['edge'],
                 linewidth=2, hatch=style['hatch'])
    bars.append(bar)

    # Combine name and value into single label
    label = interventions[name].get('label')
    if label:
        # Place intervention name at top of bar
        name_lines = name.replace(' ', '\n')
        ax.text(x_pos[i], roi * 0.65,
                name_lines,
                ha='center', va='center',
                fontsize=24, color=COLOR_BLACK, weight='bold',
                linespacing=1.1)
        # Place dollar sign and infinity symbol separately for better control
        ax.text(x_pos[i] - 0.09, roi * 0.35,
                '$',
                ha='right', va='center',
                fontsize=50, color=COLOR_BLACK, weight='bold')
        ax.text(x_pos[i] - 0.15, roi * 0.35,
                label,
                ha='left', va='center',
                fontsize=80, color=COLOR_BLACK, weight='bold',
                family='DejaVu Sans')
    else:
        # For small bars, combine name and dollar value into one label
        # Place near the bottom since bars are essentially invisible
        name_lines = name.replace(' ', '\n')
        combined_label = f'{name_lines}\n{format_parameter_value(roi, "USD")}'
        ax.text(x_pos[i], 800,
                combined_label,
                ha='center', va='bottom',
                fontsize=14, color=COLOR_BLACK, weight='bold',
                linespacing=1.1)

# Axis formatting - remove both x-axis and y-axis

ax.set_ylabel('')
ax.set_xlabel('')
ax.set_xticks([])  # Remove x-axis ticks and labels
ax.set_yticks([])  # Remove y-axis ticks

# Y-axis formatting - make infinity bar dominate, other bars should be invisible

ax.set_ylim(-500, max(rois) * 1.05)

# Title - positioned higher to avoid overlap with labels

ax.set_title('When Self-Funded by 1% Military Redirection: Infinite ROI',
            fontsize=24, color=COLOR_BLACK, weight='bold', pad=15, y=0.98)

# Add explanatory callout with inline LaTeX equation - positioned to the right

total_benefits_formatted = format_parameter_value(TREATY_TOTAL_COMPLETE_BENEFITS_ANNUAL, "USD")
callout_text = r'Treaty redirects military spending to pragmatic clinical trials at zero net cost to society.' + '\n\n' + rf'$\mathrm{{ROI}} = \frac{{{total_benefits_formatted}}}{{\$0}} = \infty$' + '\n\n' + f'Result: {total_benefits_formatted} in annual benefits (peace dividend + R&D savings)\nwith zero new spending = infinite ROI.\n\nThis is a "dominant intervention" - it saves money while saving lives.\n\nOther health interventions (shown for comparison) are invisible at this scale.'
ax.text(0.62, 0.50, callout_text,
        transform=ax.transAxes, ha='center', va='center',
        fontsize=15, color=COLOR_BLACK,
        bbox=dict(boxstyle='round,pad=1.0', facecolor=COLOR_WHITE,
                  edgecolor=COLOR_BLACK, linewidth=2, alpha=0.98),
        linespacing=1.4)

# Clean spines - remove all spines since no axes

clean_spines(ax, ['top', 'right', 'left', 'bottom'])

# Add watermark

add_watermark(fig)

# Save figure with tight bbox to minimize whitespace

output_path = get_figure_output_path('self-funding-roi-comparison-column-chart.png')

# Save the figure

plt.savefig(output_path, dpi=200, bbox_inches=None, pad_inches=0.1, facecolor=COLOR_WHITE)

# Add metadata for attribution

add_png_metadata(output_path, title="Treaty DIH dFDA ROI Comparison")

plt.show()
```
