```{python}
#| echo: false
#| fig-cap: "Probability of Exceeding Threshold: Thalidomide US Cases Prevented"
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines, get_tick_formatter,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
)
from dih_models.parameters import format_parameter_value

setup_chart_style()

# Monte Carlo samples
samples = [945, 711, 1038, 1081, 586, 673, 910, 829, 883, 740, 1067, 1044, 898, 1124, 978, 739, 958, 723, 1067, 877, 852, 767, 1147, 857, 809, 822, 992, 957, 967, 970, 1300, 813, 795, 746, 1009, 1125, 865, 742, 744, 1017, 1037, 994, 770, 931, 908, 928, 1065, 929, 1023, 899, 942, 1012, 651, 828, 802, 774, 836, 1215, 738, 1087, 621, 825, 917, 1003, 1030, 1048, 823, 803, 1062, 851, 676, 697, 729, 984, 913, 1025, 809, 916, 1011, 830, 976, 770, 820, 817, 688, 982, 802, 888, 981, 974, 1020, 868, 810, 871, 620, 652, 670, 717, 964, 732, 818, 1166, 822, 1035, 727, 848, 725, 825, 1058, 615, 971, 932, 781, 653, 900, 792, 931, 890, 1243, 842, 714, 920, 928, 1181, 1057, 955, 1207, 689, 774, 728, 816, 662, 1013, 845, 649, 715, 947, 1058, 1300, 1300, 967, 719, 567, 938, 746, 811, 778, 860, 1110, 916, 857, 712, 622, 799, 876, 1288, 911, 1091, 797, 690, 722, 760, 1300, 745, 1058, 732, 1079, 961, 857, 878, 771, 974, 805, 684, 676, 919, 1237, 916, 864, 941, 1168, 928, 812, 1119, 970, 1226, 921, 684, 663, 1256, 1276, 853, 817, 1207, 701, 733, 1015, 815, 885, 856, 952, 1193, 903, 1015, 575, 877, 741, 685, 736, 826, 1075, 669, 892, 800, 827, 1095, 993, 1176, 857, 765, 845, 933, 920, 704, 903, 930, 1300, 1298, 740, 834, 650, 782, 947, 1143, 759, 771, 565, 856, 708, 792, 736, 868, 611, 650, 1300, 675, 703, 1296, 1300, 692, 820, 952, 1277, 719, 841, 1044, 971, 818, 861, 662, 842, 837, 931, 788, 979, 1098, 916, 954, 896, 886, 761, 947, 868, 1300, 1236, 961, 754, 700, 1140, 937, 981, 613, 1078, 975, 701, 802, 937, 896, 833, 867, 840, 915, 1209, 550, 843, 920, 943, 819, 611, 950, 1277, 641, 1064, 826, 875, 709, 825, 1166, 1002, 1278, 1136, 972, 1281, 972, 1055, 832, 899, 764, 1092, 691, 1045, 851, 1135, 1038, 1295, 1034, 635, 874, 691, 794, 1220, 1014, 764, 715, 892, 685, 769, 946, 1131, 1008, 552, 945, 900, 967, 1247, 574, 782, 1004, 634, 1210, 958, 1060, 785, 1052, 1111, 931, 931, 938, 738, 859, 858, 961, 1095, 708, 863, 1212, 757, 745, 925, 1059, 888, 1173, 1062, 1059, 996, 1300, 848, 580, 1244, 804, 906, 1169, 631, 680, 631, 749, 972, 990, 939, 657, 550, 896, 802, 976, 1028, 912, 1040, 930, 991, 763, 853, 924, 1054, 815, 989, 838, 864, 1056, 581, 673, 648, 550, 768, 1038, 834, 924, 1115, 1173, 873, 1180, 903, 742, 781, 648, 734, 821, 1050, 1275, 661, 963, 711, 980, 862, 602, 1078, 780, 791, 707, 771, 970, 851, 950, 956, 1171, 824, 648, 1110, 826, 1121, 961, 862, 954, 1300, 1300, 899, 916, 1112, 741, 951, 881, 947, 743, 633, 573, 699, 804, 833, 1300, 1119, 723, 954, 813, 834, 921, 1010, 825, 1109, 696, 887, 1300, 929, 1200, 903, 1002, 875, 855, 751, 970, 740, 1020, 1115, 957, 834, 975, 830, 1080, 601, 825, 581, 646, 1182, 1071, 761, 645, 550, 790, 1300, 971, 787, 978, 637, 832, 905, 870, 1047, 953, 1020, 766, 1071, 1250, 722, 734, 1175, 851, 1192, 807, 1205, 911, 936, 1233, 821, 726, 806, 975, 636, 1014, 791, 1129, 550, 750, 620, 744, 934, 853, 840, 857, 925, 716, 1029, 1019, 961, 997, 943, 1300, 870, 830, 755, 712, 681, 734, 873, 951, 896, 754, 1072, 1036, 857, 772, 995, 922, 652, 873, 936, 732, 922, 651, 1175, 1154, 840, 957, 550, 694, 833, 706, 1030, 1300, 691, 742, 931, 1246, 684, 934, 1295, 625, 676, 810, 794, 1052, 932, 609, 988, 784, 1160, 776, 774, 993, 1041, 974, 620, 993, 712, 931, 656, 974, 747, 675, 1030, 932, 778, 1204, 807, 892, 938, 777, 979, 791, 812, 1182, 711, 550, 1246, 1300, 813, 588, 830, 834, 851, 700, 1001, 990, 646, 1027, 1300, 919, 825, 860, 1009, 614, 917, 816, 1296, 854, 1261, 702, 1003, 948, 737, 920, 1145, 827, 619, 883, 732, 824, 871, 618, 630, 981, 793, 550, 1046, 938, 762, 671, 1057, 954, 1300, 968, 962, 855, 1053, 1011, 1154, 793, 808, 801, 1047, 1216, 804, 810, 947, 841, 1084, 556, 744, 751, 550, 723, 730, 849, 1121, 841, 712, 875, 1106, 721, 731, 997, 845, 1016, 883, 1028, 712, 884, 847, 685, 637, 1024, 823, 714, 868, 1125, 553, 646, 729, 1207, 941, 1042, 696, 699, 974, 897, 995, 851, 940, 916, 1044, 1051, 629, 556, 1095, 1139, 714, 598, 905, 1079, 1294, 988, 819, 733, 888, 832, 715, 1300, 1292, 1127, 729, 1062, 1014, 973, 1154, 1013, 1036, 1014, 952, 608, 902, 788, 676, 1264, 1277, 1181, 935, 1179, 888, 925, 703, 964, 897, 673, 876, 871, 1294, 1070, 888, 934, 894, 849, 705, 858, 757, 680, 987, 962, 607, 863, 1094, 1108, 1101, 893, 741, 704, 953, 960, 1163, 1118, 862, 681, 828, 928, 849, 784, 935, 796, 776, 946, 814, 933, 939, 696, 800, 1201, 693, 568, 598, 891, 892, 864, 1145, 550, 963, 1233, 698, 818, 756, 733, 827, 1198, 1296, 825, 1300, 893, 1284, 869, 911, 957, 1300, 1061, 763, 1087, 821, 799, 1074, 892, 940, 889, 951, 969, 588, 1020, 720, 653, 875, 902, 765, 1056, 667, 813, 783, 877, 940, 716, 1033, 898, 594, 585, 884, 846, 867, 881, 929, 1083, 700, 691, 703, 942, 1153, 809, 550, 618, 743, 787, 813, 893, 829, 1106, 768, 738, 980, 640, 962, 905, 859, 1240, 777, 1300, 845, 676, 899, 706, 756, 964, 996, 777, 1092, 1132, 1200, 991, 1182, 595, 828, 738, 909, 785, 855, 1298, 855, 967, 843, 900, 887, 974, 1134, 1255, 946, 1004, 695, 870, 1081, 1064, 927, 1069, 983, 1142, 942, 822, 951, 550, 961, 550, 615, 975, 980, 693, 762, 1184, 800, 1300, 886, 966, 1247, 911, 717, 866, 879, 664, 839, 757, 1077, 892, 835, 866, 929, 1009, 717, 711, 1119, 812, 657, 973, 977, 641, 930, 1035, 959, 1013, 658, 950, 831, 800, 1065, 1211, 1293, 1170, 866, 955, 1042, 909, 911, 1055, 875, 759, 812, 1013, 887, 952, 1021, 818, 1040, 960, 682, 1202, 797, 624, 710, 714, 896, 836, 825, 1010, 952, 947, 966, 1009, 569, 820, 562, 893, 885, 1105, 1139, 925, 797, 982, 792, 886, 1091, 787, 1051, 1022, 724, 1089, 1027, 905, 754, 739, 791, 994, 724, 972, 681, 849, 907, 1300, 662, 1209, 914, 966, 908, 973, 858, 1205, 804, 1126, 773, 875, 706, 975, 1203, 872, 850, 700, 844, 633, 730, 929, 1171, 1300, 783, 1200, 933, 858, 971, 898, 907, 813, 659, 639, 1017, 836, 781, 888, 1048, 920, 771, 1148, 1237, 984, 1089, 1152, 1125, 1009, 1005, 989, 702, 1027, 665, 749, 1167, 1058, 1213, 836, 694, 842, 905, 901, 1126, 821, 954, 719, 974, 887, 756, 843, 852, 837, 1288, 868, 841, 570, 733, 838, 766, 1187, 856, 1163, 898, 893, 869, 887, 1274, 550, 580, 790, 889, 1025, 979, 817, 1099, 1102, 921, 1086, 939, 787, 1027, 907, 886, 1210, 550, 656, 689, 820, 840, 644, 719, 738, 1300, 1294, 812, 820, 695, 592, 864, 717, 870, 632, 754, 914, 957, 968, 670, 1061, 748, 1013, 884, 662, 829, 957, 1009, 860, 1225, 1096, 839, 1038, 1300, 1300, 683, 728, 1213, 708, 670, 799, 968, 867, 772, 768, 762, 736, 1300, 943, 1069, 799, 852, 762, 550, 662, 604, 556, 688, 1172, 878, 1164, 966, 1045, 732, 990, 1034, 784, 997, 999, 789, 699, 690, 902, 949, 749, 891, 1000, 1010, 1230, 1161, 717, 1265, 792, 1105, 899, 812, 604, 854, 637, 1087, 1221, 749, 944, 760, 776, 1044, 879, 1280, 800, 1094, 904, 1048, 806, 877, 865, 742, 1019, 1017, 1004, 1226, 1204, 818, 959, 776, 890, 780, 1248, 957, 846, 1140, 563, 579, 1048, 897, 934, 669, 882, 1300, 1055, 918, 807, 815, 567, 936, 1059, 635, 770, 694, 722, 896, 572, 1009, 1039, 840, 550, 718, 1150, 550, 823, 690, 1050, 768, 965, 998, 1296, 849, 959, 647, 1140, 754, 787, 882, 637, 930, 1087, 943, 633, 863, 1036, 596, 706, 1066, 938, 967, 1297, 978, 1018, 1300, 847, 748, 970, 972, 793, 712, 1300, 949, 759, 1075, 866, 840, 998, 674, 955, 1300, 978, 818, 796, 812, 840, 818, 1075, 614, 1063, 818, 959, 698, 1173, 1153, 1085, 643, 1056, 965, 631, 881, 957, 997, 920, 942, 1210, 1148, 550, 828, 856, 612, 904, 1154, 704, 951, 730, 769, 1211, 790, 977, 596, 1297, 1006, 852, 1001, 658, 1138, 827, 849, 798, 784, 1026, 935, 1017, 884, 988, 811, 1300, 636, 1157, 1183, 740, 1300, 1094, 1088, 891, 846, 848, 962, 1191, 921, 731, 1055, 1076, 1018, 1037, 837, 728, 737, 627, 931, 870, 807, 550, 681, 1123, 770, 956, 660, 1201, 859, 942, 1300, 1221, 830, 782, 827, 987, 866, 815, 1208, 865, 1300, 903, 1292, 955, 1086, 760, 740, 976, 1092, 894, 675, 664, 655, 610, 907, 1124, 883, 555, 851, 856, 1300, 651, 816, 1271, 974, 998, 908, 950, 1044, 747, 1067, 663, 950, 920, 778, 882, 777, 706, 822, 701, 949, 695, 1030, 690, 786, 776, 1172, 950, 847, 985, 569, 878, 1300, 911, 899, 995, 1071, 581, 621, 926, 762, 1169, 829, 588, 678, 550, 843, 851, 810, 1113, 1142, 855, 567, 1009, 996, 946, 1090, 693, 1300, 723, 1038, 620, 728, 1221, 838, 1058, 931, 867, 1182, 843, 608, 748, 995, 963, 636, 760, 783, 820, 662, 776, 759, 1043, 1051, 859, 815, 913, 745, 695, 726, 775, 693, 917, 1034, 633, 891, 846, 952, 884, 651, 678, 891, 1101, 559, 953, 1139, 858, 995, 764, 864, 629, 550, 1081, 719, 805, 661, 658, 854, 759, 960, 975, 948, 932, 1237, 707, 876, 1126, 1158, 656, 829, 1181, 986, 923, 846, 817, 942, 840, 878, 901, 768, 991, 1300, 608, 949, 754, 1001, 895, 1041, 1136, 923, 1126, 550, 1240, 959, 1113, 684, 743, 914, 883, 941, 1114, 610, 1089, 888, 849, 649, 985, 550, 1016, 646, 896, 864, 1135, 853, 765, 796, 1160, 992, 817, 843, 636, 962, 611, 1039, 910, 1300, 702, 867, 1294, 1140, 765, 929, 886, 940, 764, 869, 632, 912, 974, 844, 630, 1092, 957, 760, 835, 645, 713, 791, 1149, 774, 1014, 791, 934, 860, 1066, 791, 635, 661, 792, 680, 966, 803, 1300, 613, 925, 698, 798, 913, 550, 931, 1299, 805, 936, 1100, 856, 784, 553, 1015, 865, 715, 910, 783, 792, 1007, 668, 1106, 659, 770, 1300, 1124, 904, 726, 792, 900, 893, 869, 880, 847, 653, 794, 1075, 663, 851, 745, 907, 816, 1211, 986, 671, 1021, 752, 784, 947, 798, 1070, 752, 777, 771, 786, 1118, 1012, 1272, 1300, 712, 899, 691, 752, 775, 708, 709, 859, 685, 1059, 730, 1300, 805, 900, 674, 1271, 1123, 943, 666, 926, 699, 1207, 1051, 904, 550, 720, 1025, 1145, 1120, 633, 944, 1098, 624, 884, 939, 831, 599, 827, 827, 859, 786, 807, 879, 973, 831, 812, 903, 590, 980, 886, 893, 1086, 586, 584, 939, 885, 918, 803, 1020, 1079, 981, 838, 569, 1042, 1147, 1015, 736, 1022, 1063, 1232, 736, 845, 1038, 897, 700, 967, 1001, 903, 928, 839, 1211, 732, 782, 888, 1067, 645, 672, 576, 892, 699, 817, 1019, 774, 930, 832, 1021, 980, 765, 855, 1105, 963, 659, 1018, 704, 1194, 1100, 942, 916, 848, 1023, 819, 931, 1065, 787, 778, 688, 707, 602, 1034, 1294, 1198, 628, 1033, 1197, 804, 905, 579, 937, 708, 924, 637, 994, 1100, 751, 697, 565, 837, 783, 638, 975, 806, 706, 788, 1111, 1006, 862, 1010, 693, 892, 914, 802, 971, 751, 987, 996, 550, 1140, 550, 778, 1100, 828, 650, 703, 1101, 590, 1125, 876, 688, 783, 714, 1064, 1034, 616, 813, 738, 1165, 666, 1244, 880, 693, 768, 748, 677, 904, 683, 562, 818, 605, 756, 731, 737, 1300, 897, 933, 608, 772, 927, 713, 1074, 687, 834, 783, 917, 774, 837, 843, 759, 982, 932, 870, 809, 1048, 843, 830, 906, 1268, 667, 1043, 594, 928, 1236, 982, 919, 787, 892, 840, 750, 833, 924, 753, 747, 664, 962, 994, 930, 1087, 903, 963, 945, 869, 792, 1300]
thresholds = [671, 884, 1162]
display_name = "Thalidomide US Cases Prevented"
units = "cases"

# Calculate exceedance probabilities (1 - CDF)
sorted_samples = np.sort(samples)
exceedance = 1 - np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot exceedance curve
ax.plot(sorted_samples, exceedance * 100, color=COLOR_BLACK, linewidth=2.5)
ax.fill_between(sorted_samples, 0, exceedance * 100, alpha=0.1, color=COLOR_BLACK)

# Apply tick formatter for readable labels (K, M, B suffixes, $ for USD)
ax.xaxis.set_major_formatter(get_tick_formatter(unit=units))

# Annotate thresholds
for thresh in thresholds:
    exceed_pct = (np.array(samples) >= thresh).sum() / len(samples) * 100
    ax.axvline(thresh, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
    ax.axhline(exceed_pct, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.3)
    
    # Add label with formatted threshold value (use format_parameter_value for full units)
    ax.annotate(f'{exceed_pct:.0f}% chance\nâ‰¥ {format_parameter_value(thresh, units)}',
                xy=(thresh, exceed_pct), xytext=(thresh * 1.05, exceed_pct + 5),
                fontsize=10, ha='left', weight='bold',
                bbox=dict(boxstyle='round,pad=0.3', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, alpha=0.9))

ax.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=12)
ax.set_ylabel('Probability of Exceeding Value (%)', fontsize=12)
ax.set_title(f'Exceedance Probability: {display_name}', fontsize=14, weight='bold', pad=15)
ax.set_ylim(0, 100)
ax.set_xlim(left=min(sorted_samples) * 0.95)

clean_spines(ax)
add_watermark(fig)

# Save PNG to knowledge/figures/ regardless of where Quarto renders from
output_path = get_figure_output_path('exceedance-thalidomide_us_cases_prevented.png')
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Exceedance: {display_name}',
    description=f'Probability of {display_name} exceeding various thresholds'
)

plt.show()
```

*This exceedance probability chart shows the likelihood that Thalidomide US Cases Prevented will exceed any given threshold. Higher curves indicate more favorable outcomes with greater certainty.*
