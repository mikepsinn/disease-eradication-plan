```{python}
#| echo: false
from dih_models.parameters import *
```

```{python}
#| fig-cap: "Monte Carlo Simulation: ROI Uncertainty Distribution (10,000 iterations)"
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

# Import centralized style

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path)

# Import parameters

from dih_models.parameters import (
    DFDA_ROI_RD_PLUS_DELAY,  # Recommended: R&D + regulatory delay elimination
    TRIAL_COST_REDUCTION_PCT,
    DFDA_NPV_ADOPTION_RAMP_YEARS,
    NPV_DISCOUNT_RATE_STANDARD,
)

setup_chart_style()

# Run Monte Carlo simulation inline

N_ITERATIONS = 10000
np.random.seed(42)  # For reproducibility

# Sample from probability distributions

cost_reduction_samples = np.random.beta(2, 1.5, N_ITERATIONS) * 0.45 + 0.50
political_prob_samples = np.clip(np.random.normal(0.25, 0.15, N_ITERATIONS), 0.05, 0.60)
adoption_years_samples = np.clip(np.random.normal(5, 1.5, N_ITERATIONS), 3, 8)
discount_rate_samples = np.clip(np.random.normal(3, 1.5, N_ITERATIONS) / 100, 0.01, 0.07)
qaly_multiplier_samples = np.clip(np.random.normal(1.0, 0.15, N_ITERATIONS), 0.7, 1.3)

# Calculate ROI for each iteration

base_roi = float(DFDA_ROI_RD_PLUS_DELAY)  # Recommended: R&D + regulatory delay elimination
cost_reduction_factor = cost_reduction_samples / (float(TRIAL_COST_REDUCTION_PCT) / 100)
discount_rate_factor = (1 + float(NPV_DISCOUNT_RATE_STANDARD) / 100) / (1 + discount_rate_samples)
adoption_factor = float(DFDA_NPV_ADOPTION_RAMP_YEARS) / adoption_years_samples

conditional_samples = (
    base_roi 
    * cost_reduction_factor ** 0.5
    * qaly_multiplier_samples ** 0.3
    * discount_rate_factor ** 2
    * adoption_factor ** 0.3
)

expected_samples = conditional_samples * political_prob_samples

# Calculate percentiles

cp = {
    'p5': np.percentile(conditional_samples, 5),
    'p50': np.percentile(conditional_samples, 50),
    'p95': np.percentile(conditional_samples, 95),
}
ep = {
    'p5': np.percentile(expected_samples, 5),
    'p50': np.percentile(expected_samples, 50),
    'p95': np.percentile(expected_samples, 95),
}

# Create figure with two subplots - add extra top space for main title

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(16, 8))
fig.subplots_adjust(top=0.80, bottom=0.12, wspace=0.3)  # More space for title, room for watermark, space between subplots

# --- Left: Conditional ROI Distribution ---

ax1.hist(conditional_samples, bins=50, color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1.5)
ax1.axvline(cp['p50'], color=COLOR_BLACK, linestyle='--', linewidth=2, label=f"Median: {cp['p50']:.1f}:1")
ax1.axvline(cp['p5'], color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f"5th: {cp['p5']:.1f}:1")
ax1.axvline(cp['p95'], color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f"95th: {cp['p95']:.1f}:1")
ax1.set_title('Conditional ROI\n(If Implementation Succeeds)', fontsize=24, weight='bold', pad=20)
ax1.set_xlabel('ROI (ratio)', fontsize=18)
ax1.set_ylabel('Frequency', fontsize=18)
# Move legend to upper right to avoid title overlap

ax1.legend(fontsize=14, loc='upper right', framealpha=1.0, 
           bbox_to_anchor=(0.98, 0.98), frameon=True, 
           edgecolor=COLOR_BLACK, facecolor=COLOR_WHITE)
# Move CI box to bottom left with more spacing

ax1.text(0.02, 0.08, f"95% CI: [{cp['p5']:.1f}:1, {cp['p95']:.1f}:1]", 
         transform=ax1.transAxes, fontsize=16, weight='bold',
         verticalalignment='bottom', 
         bbox=dict(boxstyle='round,pad=0.6', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1.5))
clean_spines(ax1)

# --- Right: Expected ROI Distribution (with political risk) ---

ax2.hist(expected_samples, bins=50, color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1.5)
ax2.axvline(ep['p50'], color=COLOR_BLACK, linestyle='--', linewidth=2, label=f"Median: {ep['p50']:.1f}:1")
ax2.axvline(ep['p5'], color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f"5th: {ep['p5']:.1f}:1")
ax2.axvline(ep['p95'], color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f"95th: {ep['p95']:.1f}:1")
ax2.set_title('Expected ROI\n(Accounting for Political Risk)', fontsize=24, weight='bold', pad=20)
ax2.set_xlabel('ROI (ratio)', fontsize=18)
ax2.set_ylabel('Frequency', fontsize=18)
# Move legend to upper right to avoid title overlap - white background with black text

ax2_legend = ax2.legend(fontsize=14, loc='upper right', framealpha=1.0,
           bbox_to_anchor=(0.98, 0.98), frameon=True,
           edgecolor=COLOR_BLACK, facecolor=COLOR_WHITE)
# Set legend text color to black for readability on white background
for text in ax2_legend.get_texts():
    text.set_color(COLOR_BLACK)
# Move CI box to bottom left with more spacing - white background with black text

ax2.text(0.02, 0.08, f"95% CI: [{ep['p5']:.1f}:1, {ep['p95']:.1f}:1]", 
         transform=ax2.transAxes, fontsize=16, weight='bold', color=COLOR_BLACK,
         verticalalignment='bottom',
         bbox=dict(boxstyle='round,pad=0.6', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1.5))
clean_spines(ax2)

# Add overall title - positioned higher to avoid overlap with subplot titles

fig.suptitle('Monte Carlo Simulation: ROI Uncertainty Quantification', 
             fontsize=28, weight='bold', y=0.99)

# Add watermark

add_watermark(fig)

# Save PNG

output_path = get_figure_output_path('monte-carlo-roi-distribution-chart.png')
plt.savefig(output_path, dpi=200, bbox_inches=None, facecolor=COLOR_WHITE)
add_png_metadata(output_path, 
                 title="Monte Carlo Simulation: ROI Uncertainty Distribution",
                 description="Probabilistic sensitivity analysis showing ROI distribution with 95% confidence intervals")

plt.show()
```

