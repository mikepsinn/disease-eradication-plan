```{python}
#| echo: false
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata
)
from dih_models.parameters import format_parameter_value

setup_chart_style()

# Display name for chart title
display_name = "Misallocation Factor: Cost to Kill vs Cost to Save"

# Baseline and units
baseline = 2888.550922140456

# Tornado data from sensitivity analysis
drivers = ['GLOBAL_ANNUAL_LIVES_SAVED_BY_MED_RESEARCH', 'GLOBAL_MED_RESEARCH_SPENDING', 'GLOBAL_ANNUAL_CONFLICT_DEATHS_ACTIVE_COMBAT', 'VALUE_OF_STATISTICAL_LIFE', 'GLOBAL_ANNUAL_LOST_ECONOMIC_GROWTH_MILITARY_SPENDING', 'GLOBAL_MILITARY_SPENDING_ANNUAL_2024', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_TRANSPORTATION_CONFLICT', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_ENERGY_CONFLICT', 'GLOBAL_ANNUAL_CONFLICT_DEATHS_TERROR_ATTACKS', 'GLOBAL_ANNUAL_LOST_HUMAN_CAPITAL_CONFLICT', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_COMMUNICATIONS_CONFLICT', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_WATER_CONFLICT', 'GLOBAL_ANNUAL_TRADE_DISRUPTION_SHIPPING_CONFLICT', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_EDUCATION_CONFLICT', 'GLOBAL_ANNUAL_PSYCHOLOGICAL_IMPACT_COSTS_CONFLICT', 'GLOBAL_ANNUAL_VETERAN_HEALTHCARE_COSTS', 'GLOBAL_ANNUAL_TRADE_DISRUPTION_SUPPLY_CHAIN_CONFLICT', 'GLOBAL_ANNUAL_CONFLICT_DEATHS_STATE_VIOLENCE', 'GLOBAL_ANNUAL_INFRASTRUCTURE_DAMAGE_HEALTHCARE_CONFLICT', 'GLOBAL_ANNUAL_REFUGEE_SUPPORT_COSTS', 'GLOBAL_ANNUAL_TRADE_DISRUPTION_ENERGY_PRICE_CONFLICT', 'GLOBAL_ANNUAL_ENVIRONMENTAL_DAMAGE_CONFLICT', 'GLOBAL_ANNUAL_TRADE_DISRUPTION_CURRENCY_CONFLICT']
impacts_low = [-825.3002634687018, 722.1377305351143, 635.9959074116096, -311.11111111111086, -208.08576360497864, -69.19233215226632, -37.47070046334147, -32.23039883710362, 21.51281886014067, -22.89452166802903, -22.665576451348898, -20.554192786408294, -18.849822840010347, -17.934041973289368, -17.8068501862449, -15.28845280276164, -14.194603434178134, 11.173354313483742, -12.617425274824654, -11.447260834014287, -9.590260743163071, -7.631507222676191, -4.426274189152082]
impacts_high = [1237.9503952030523, -481.42515369007606, -483.8721082783618, 311.1111111111113, 275.24302716453167, 69.19233215226677, 49.01971472699233, 42.81275551921544, -33.77130966450841, 30.52602889070613, 30.500590533297327, 27.26991914236396, 25.15853547742381, 23.784864177342115, 23.657672390297193, 20.325247569728617, 19.129644771508993, -21.112013000453317, 16.891069319523922, 15.263014445353292, 12.795493776687636, 10.17534296356871, 5.749068774416628]

# Convert deltas to absolute values (baseline + delta)
values_low = [baseline + delta for delta in impacts_low]
values_high = [baseline + delta for delta in impacts_high]

# Create tornado chart (horizontal bars showing swing range)
fig, ax = plt.subplots(figsize=(10, max(6, len(drivers) * 0.8)))

y_pos = np.arange(len(drivers))

# Plot low impact (left side)
for i, (low, high) in enumerate(zip(values_low, values_high)):
    left = min(low, high)
    width_low = baseline - left if left < baseline else 0
    width_high = max(low, high) - baseline if max(low, high) > baseline else 0

    # White bar for range below baseline
    if width_low > 0:
        ax.barh(i, width_low, left=left,
                color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=2)

    # Black bar for range above baseline
    if width_high > 0:
        ax.barh(i, width_high, left=baseline,
                color=COLOR_BLACK, edgecolor=COLOR_BLACK, linewidth=2)

# Format axis
ax.set_yticks(y_pos)
# Simplified labels (just parameter names)
ax.set_yticklabels([d.replace('_', ' ').title() for d in drivers], fontsize=11)
ax.set_title(f'Sensitivity Analysis: {display_name}', fontsize=16, weight='bold', pad=20)

# X-axis label with units
units_label = "ratio"
if units_label:
    ax.set_xlabel(f'{display_name} ({units_label})', fontsize=12)
else:
    ax.set_xlabel(f'{display_name}', fontsize=12)

# Add vertical line at baseline
ax.axvline(baseline, color=COLOR_BLACK, linewidth=1, linestyle='--', alpha=0.5)

# Clean spines
clean_spines(ax)

# Add watermark
add_watermark(fig)

# Save PNG (same directory as the QMD file)
output_path = Path('tornado-misallocation_factor_death_vs_saving.png')
plt.savefig(output_path, dpi=200, bbox_inches=None, facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Sensitivity: {display_name}',
    description=f'Tornado diagram showing which input parameters have the largest impact on {display_name}'
)

plt.show()
```