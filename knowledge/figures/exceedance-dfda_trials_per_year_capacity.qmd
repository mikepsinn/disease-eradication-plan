```{python}
#| echo: false
#| fig-cap: "Probability of Exceeding Threshold: dFDA Maximum Trials per Year"
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata
)

setup_chart_style()

# Monte Carlo samples
samples = [83657, 93833, 80621, 79359, 110313, 98439, 84894, 88078, 85918, 92087, 79763, 80438, 85330, 77199, 82535, 92135, 83214, 92899, 79769, 86154, 87124, 90782, 75865, 86905, 88901, 88341, 82093, 83237, 82911, 82787, 66040, 88739, 89521, 91788, 81525, 77175, 86613, 91989, 91869, 81291, 80669, 82019, 90666, 84162, 84972, 84256, 79816, 84222, 81101, 85319, 83766, 81422, 101268, 88103, 89211, 90466, 87779, 72178, 92185, 79177, 105533, 88215, 84648, 81727, 80884, 80334, 88316, 89152, 79905, 87170, 97964, 95447, 92596, 82333, 84791, 81023, 88893, 84678, 81460, 88028, 82609, 90639, 88421, 88558, 96545, 82402, 89204, 85710, 82445, 82679, 81192, 86502, 88864, 86367, 105619, 101082, 98809, 93195, 83000, 92489, 88532, 74808, 88371, 80707, 92705, 87273, 92831, 88245, 80022, 106393, 82762, 84123, 90132, 101063, 85287, 89650, 84159, 85643, 70781, 87518, 93550, 84532, 84247, 73992, 80057, 83296, 72597, 96420, 90473, 92650, 88617, 99789, 81396, 87394, 101521, 93415, 83596, 80037, 66041, 66040, 82900, 93135, 110420, 83914, 91782, 88805, 90266, 86806, 78069, 84688, 86935, 93759, 105375, 89329, 86182, 68662, 84876, 79082, 89425, 96352, 92947, 91116, 66040, 91846, 80034, 92469, 79419, 83102, 86920, 86089, 90586, 82682, 89097, 97071, 98004, 84579, 71075, 84667, 86647, 83788, 74716, 84251, 88773, 77495, 82801, 71641, 84504, 97051, 99634, 70147, 69220, 87085, 88569, 72621, 94990, 92406, 81340, 88652, 85835, 86969, 83430, 73342, 85156, 81336, 110372, 86146, 92012, 96951, 92279, 88209, 79522, 98876, 85581, 89313, 88162, 78951, 82053, 74288, 86905, 90896, 87406, 84090, 84551, 94598, 85157, 84190, 66040, 67355, 92089, 87868, 101384, 90106, 83582, 76097, 91146, 90581, 110493, 86964, 94218, 89649, 92269, 86472, 106986, 101451, 66040, 98174, 94812, 67801, 66040, 96117, 88459, 83402, 69156, 93115, 87561, 80441, 82760, 88517, 86756, 99757, 87510, 87715, 84162, 89842, 82508, 78833, 84699, 83332, 85421, 85798, 91089, 83576, 86493, 66041, 71150, 83096, 91403, 95083, 76302, 83949, 82449, 106729, 79446, 82625, 95049, 89220, 83942, 85426, 87903, 86538, 87610, 84720, 72488, 110568, 87500, 84552, 83718, 88486, 106966, 83496, 69173, 102698, 79866, 88168, 86236, 94055, 88211, 74797, 81751, 69110, 76494, 82730, 68964, 82731, 80104, 87935, 85326, 90907, 79037, 96236, 80408, 87166, 76580, 80618, 68003, 80753, 103417, 86276, 96125, 89566, 71963, 81379, 90918, 93383, 85565, 96911, 90709, 83607, 76804, 81574, 110567, 83660, 85287, 82903, 70594, 110379, 90109, 81695, 103598, 72429, 83217, 79981, 89958, 80199, 78033, 84157, 84147, 83896, 92166, 86855, 86890, 83113, 78970, 94152, 86692, 72356, 91255, 91852, 84371, 79995, 85717, 74403, 79913, 80012, 81945, 66040, 87271, 110344, 70749, 89117, 85034, 74667, 103990, 97534, 103971, 91639, 82726, 82148, 83855, 100450, 110567, 85412, 89222, 82591, 80946, 84820, 80556, 84183, 82108, 90961, 87086, 84410, 80154, 88646, 82169, 87711, 86639, 80094, 110338, 98337, 101732, 110567, 90762, 80628, 87849, 84402, 77738, 74420, 86292, 74068, 85145, 91968, 90133, 101702, 92356, 88384, 80266, 69256, 99890, 83048, 93842, 82486, 86736, 108426, 79440, 90213, 89682, 94345, 90582, 82807, 87156, 83491, 83261, 74516, 88272, 101633, 78051, 88190, 77378, 83113, 86737, 83352, 66473, 66041, 85306, 84666, 77923, 92031, 83461, 85983, 83593, 91937, 103749, 110385, 95170, 89125, 87910, 66636, 77500, 92924, 83359, 88744, 87846, 84490, 81504, 88246, 78099, 95598, 85753, 66040, 84226, 72997, 85150, 81764, 86203, 87019, 91527, 82790, 92076, 81190, 77794, 83229, 87859, 82628, 88023, 79392, 108436, 88220, 110336, 101972, 73929, 79659, 91073, 102111, 110568, 89754, 66040, 82759, 89873, 82552, 103208, 87940, 85093, 86413, 80351, 83381, 81172, 90838, 79641, 70430, 92986, 92352, 74310, 87171, 73391, 89005, 72706, 84868, 83980, 71262, 88411, 92762, 89050, 82639, 103298, 81380, 89719, 76909, 110567, 91581, 105602, 91883, 84054, 87083, 87620, 86939, 84363, 93295, 80913, 81210, 83102, 81928, 83715, 66041, 86420, 88011, 91331, 93700, 97407, 92361, 86303, 83452, 85435, 91422, 79626, 80695, 86942, 90572, 81983, 84471, 101101, 86283, 83954, 92444, 84458, 101225, 74304, 75513, 87614, 83251, 110567, 95850, 87914, 94386, 80862, 66041, 96206, 91968, 84139, 70660, 97014, 84044, 67994, 104935, 98060, 88866, 89583, 80206, 84096, 107323, 82208, 90007, 75148, 90382, 90449, 82033, 80537, 82668, 105585, 82054, 93735, 84140, 100651, 82680, 91733, 98088, 80866, 84096, 90280, 72758, 88992, 85570, 83906, 90322, 82510, 89679, 88778, 73946, 93843, 110567, 70662, 66040, 88731, 110304, 88036, 87859, 87160, 95100, 81772, 82146, 101960, 80964, 66041, 84583, 88232, 86815, 81530, 106459, 84637, 88622, 67703, 87047, 69930, 94933, 81720, 83555, 92210, 84545, 76004, 88133, 105708, 85923, 92465, 88269, 86381, 105973, 104245, 82436, 89599, 110568, 80391, 83882, 91031, 98703, 80052, 83348, 66040, 82860, 83083, 86994, 80179, 81464, 75461, 89589, 88953, 89276, 80351, 72132, 89126, 88875, 83592, 87565, 79284, 110567, 91886, 91550, 110567, 92936, 92563, 87241, 77401, 87560, 93676, 86205, 78309, 93031, 92528, 81914, 87389, 81312, 85896, 80948, 93749, 85884, 87311, 96899, 103255, 81055, 88332, 93530, 86485, 77188, 110567, 102001, 92622, 72625, 83811, 80508, 95567, 95207, 82670, 85385, 81981, 87144, 83842, 84681, 80438, 80243, 104325, 110567, 78958, 76350, 93501, 109001, 85097, 79423, 68290, 82202, 88484, 92394, 85717, 87954, 93406, 66041, 68445, 77075, 92606, 79925, 81365, 82706, 75490, 81394, 80691, 81384, 83407, 107493, 85205, 89848, 98038, 69752, 69152, 73992, 84001, 74108, 85713, 84367, 94755, 83019, 85370, 98448, 86163, 86368, 68290, 79665, 85717, 84046, 85484, 87254, 94564, 86880, 91274, 97511, 82237, 83059, 107554, 86676, 78997, 78165, 78644, 85522, 92026, 94586, 83381, 83141, 74971, 77585, 86744, 97402, 88099, 84266, 87248, 90010, 84018, 89460, 90385, 83611, 88707, 84079, 83876, 95554, 89292, 72936, 95951, 110411, 109041, 85591, 85579, 86639, 75981, 110568, 83027, 71305, 95351, 88544, 91326, 92403, 88151, 73074, 67795, 88222, 67018, 85546, 68841, 86465, 84871, 83237, 66040, 79949, 90981, 79172, 88412, 89355, 79570, 85577, 83839, 85699, 83436, 82827, 110304, 81184, 93077, 100993, 86215, 85203, 90877, 80084, 99162, 88743, 90062, 86130, 83837, 93284, 80796, 85351, 109642, 110317, 85886, 87385, 86537, 85998, 84208, 79313, 95061, 96124, 94752, 83767, 75555, 88923, 110568, 105941, 91935, 89860, 88754, 85524, 88045, 78307, 90745, 92158, 82458, 102731, 83070, 85072, 86854, 70956, 90341, 66041, 87417, 97988, 85302, 94457, 91317, 83019, 81935, 90341, 79052, 76773, 72956, 82113, 73935, 109419, 88090, 92194, 84954, 89962, 86989, 67291, 87014, 82904, 87467, 85261, 85756, 82667, 76663, 70192, 83623, 81704, 95754, 86426, 79361, 79852, 84306, 79717, 82376, 76174, 83764, 88367, 83442, 110568, 83117, 110568, 106318, 82643, 82467, 95957, 91017, 73839, 89312, 66040, 85812, 82943, 70585, 84871, 93234, 86583, 86052, 99572, 87638, 91245, 79466, 85552, 87834, 86557, 84225, 81519, 93214, 93860, 77518, 88783, 100524, 82698, 82564, 102639, 84181, 80720, 83175, 81417, 100294, 83475, 87979, 89303, 79822, 72385, 68330, 74595, 86583, 83325, 80511, 84940, 84873, 80132, 86221, 91147, 88799, 81404, 85777, 83411, 81160, 88507, 80582, 83145, 97235, 72876, 89436, 104999, 93920, 93508, 85428, 87769, 88229, 81500, 83414, 83579, 82931, 81524, 110406, 88431, 110567, 85542, 85831, 78361, 76351, 84368, 89433, 82415, 89638, 85808, 79060, 89860, 80252, 81111, 92867, 79140, 80969, 85076, 91397, 92134, 89710, 82023, 92874, 82741, 97358, 87263, 85022, 66040, 99801, 72481, 84739, 82922, 84960, 82691, 86899, 72720, 89108, 77129, 90508, 86228, 94383, 82621, 72838, 86351, 87211, 95122, 87445, 103810, 92545, 84200, 74538, 66040, 90075, 72969, 84081, 86881, 82775, 85359, 85016, 88753, 100181, 102881, 81274, 87790, 90146, 85738, 80324, 84525, 90595, 75813, 71074, 82350, 79142, 75596, 77159, 81538, 81644, 82179, 94822, 80954, 99409, 91642, 74749, 80023, 72277, 87753, 95778, 87526, 85075, 85238, 77108, 88408, 83330, 93128, 82653, 85776, 91302, 87493, 87119, 87742, 68619, 86502, 87551, 110399, 92402, 87691, 90820, 73688, 86980, 74956, 85360, 85534, 86433, 85771, 69281, 110567, 110343, 89751, 85695, 81025, 82497, 88576, 78742, 78581, 84499, 79214, 83880, 89888, 80974, 85015, 85789, 72468, 110567, 100540, 96390, 88422, 87629, 102201, 93102, 92147, 66040, 68238, 88779, 88425, 95725, 109967, 86634, 93200, 86404, 103951, 91395, 84747, 83232, 82879, 98770, 79927, 91685, 81411, 85874, 99784, 88078, 83238, 81546, 86807, 71693, 78908, 87644, 80623, 66677, 66362, 97114, 92650, 72310, 94147, 98807, 89328, 82860, 86530, 90554, 90732, 91019, 92290, 66040, 83707, 79714, 89350, 87132, 91028, 110568, 99813, 108025, 110567, 96536, 74457, 86115, 74927, 82923, 80406, 92453, 82150, 80766, 90001, 81908, 81863, 89799, 95264, 96338, 85185, 83503, 91626, 85609, 81833, 81510, 71430, 75113, 93226, 69729, 89661, 78371, 85316, 88782, 107967, 87028, 103178, 79184, 71890, 91660, 83676, 91118, 90389, 80460, 86073, 69018, 89299, 78973, 85108, 80318, 89040, 86152, 86624, 91958, 81214, 81294, 81677, 71625, 72782, 88508, 83184, 90352, 85632, 90173, 70544, 83249, 87364, 76267, 110567, 110350, 80318, 85369, 84035, 98876, 85964, 66041, 80129, 84599, 88980, 88652, 110418, 83985, 79988, 103484, 90636, 95870, 92949, 85419, 110392, 81537, 80598, 87604, 110568, 93189, 75721, 110568, 88307, 96265, 80260, 90739, 82972, 81867, 67809, 87255, 83164, 101786, 76312, 91383, 89882, 85957, 103244, 84186, 79183, 83739, 103736, 86684, 80677, 109363, 94431, 79782, 83898, 82916, 67563, 82528, 81242, 66040, 87333, 91667, 82808, 82731, 89629, 93703, 66040, 83504, 91170, 79522, 86578, 87617, 81889, 98254, 83325, 66924, 82544, 88517, 89483, 88768, 87625, 88529, 79519, 106508, 79878, 88543, 83158, 95337, 74407, 75545, 79234, 102340, 80096, 82965, 104047, 85971, 83243, 81931, 84546, 83751, 72460, 75817, 110568, 88087, 86978, 106876, 85131, 75502, 94635, 83438, 92568, 90715, 72410, 89747, 82572, 109227, 67529, 81615, 87107, 81799, 100395, 76422, 88135, 87263, 89369, 90031, 80995, 83997, 81284, 85861, 82223, 88831, 66040, 103339, 75334, 73874, 92081, 66040, 78999, 79158, 85599, 87358, 87301, 83064, 73426, 84518, 92534, 80128, 79487, 81264, 80654, 87748, 92669, 92203, 104623, 84129, 86394, 88987, 110568, 97457, 77289, 90660, 83270, 100045, 72924, 86829, 83759, 66040, 71894, 88008, 90125, 88146, 82246, 86550, 88657, 72545, 86615, 66040, 85155, 68443, 83293, 79212, 91112, 92093, 82589, 79044, 85512, 98156, 99490, 100714, 107180, 85023, 77230, 85894, 110567, 87166, 86965, 66041, 101268, 88624, 69446, 82655, 81882, 84987, 83482, 80439, 91755, 79772, 99722, 83493, 84536, 90297, 85960, 90344, 94378, 88352, 94937, 83532, 95740, 80879, 96291, 89924, 90359, 74455, 83480, 87318, 82322, 110405, 86106, 66041, 84862, 85316, 81985, 79656, 110340, 105522, 84315, 91038, 74633, 88070, 110303, 97827, 110568, 87480, 87149, 88872, 77885, 76199, 87019, 110421, 81516, 81936, 83625, 79091, 95999, 66041, 92903, 80629, 105619, 92679, 71895, 87675, 80025, 84129, 86548, 73929, 87499, 107437, 91708, 81964, 83030, 103323, 91110, 90039, 88439, 99775, 90388, 91142, 80480, 80229, 86842, 88634, 84808, 91809, 95683, 92755, 90436, 95975, 84653, 80760, 103702, 85620, 87378, 83402, 85890, 101202, 97726, 85589, 78602, 110567, 83373, 76323, 86894, 81971, 90949, 86652, 104345, 110567, 79345, 93100, 89101, 99967, 100398, 87044, 91149, 83151, 82638, 83545, 84117, 71092, 94308, 86190, 77122, 75285, 100615, 88050, 74007, 82258, 84420, 87361, 88573, 83772, 87613, 86102, 85241, 90761, 82094, 66040, 107363, 83523, 91381, 81786, 85468, 80545, 76521, 84440, 77131, 110567, 70927, 83171, 77900, 96970, 91917, 84766, 85920, 83808, 77805, 107133, 79141, 85739, 87261, 101527, 82292, 110567, 81306, 101917, 85419, 86650, 76604, 87079, 90882, 89480, 75170, 82066, 88586, 87497, 103325, 83078, 107027, 80612, 84888, 66040, 94870, 86532, 68281, 76299, 90898, 84219, 85784, 83815, 90916, 86436, 103910, 84842, 82655, 87432, 104233, 79044, 83243, 91122, 87818, 102076, 93583, 89711, 75784, 90471, 81361, 89715, 84052, 86810, 79805, 89689, 103426, 99885, 89667, 97488, 82928, 89177, 66040, 106596, 84362, 95354, 89382, 84798, 110567, 84130, 67044, 89086, 83969, 78657, 86973, 90033, 110567, 81356, 86607, 93366, 84902, 90053, 89642, 81591, 99093, 78336, 100173, 90645, 66805, 77197, 85107, 92758, 89648, 85279, 85532, 86447, 86018, 87337, 100987, 89553, 79530, 99637, 87158, 91833, 85010, 88609, 72410, 82268, 98613, 81152, 91491, 90003, 83594, 89369, 79674, 91490, 90317, 90598, 89919, 77596, 81439, 69394, 66040, 93674, 85299, 96199, 91513, 90400, 94128, 94037, 86831, 96914, 80010, 92583, 66040, 89071, 85287, 98317, 69443, 77308, 83711, 99246, 84312, 95240, 72609, 80229, 85122, 110567, 93088, 81041, 75999, 77455, 103795, 83679, 78793, 105061, 85855, 83872, 87965, 108848, 88147, 88159, 86858, 89903, 89009, 86081, 82707, 87992, 88763, 85144, 110223, 82470, 85802, 85516, 79227, 110314, 110326, 83872, 85849, 84596, 89150, 81199, 79412, 82423, 87674, 110406, 80495, 75876, 81332, 92291, 81135, 79888, 71339, 92264, 87425, 80642, 85391, 95169, 82898, 81778, 85175, 84250, 87659, 72398, 92452, 90081, 85720, 79766, 102015, 98586, 110364, 85566, 95186, 88579, 81219, 90486, 84168, 87955, 81146, 82483, 90865, 87007, 78387, 83044, 100160, 81258, 94601, 73274, 78669, 83760, 84687, 87299, 81103, 88477, 84138, 79812, 89890, 90296, 96519, 94254, 108376, 80759, 68149, 73103, 104443, 80792, 73146, 89111, 85080, 110347, 83921, 94238, 84390, 103212, 82021, 78663, 91555, 95510, 110567, 87715, 90038, 103020, 82635, 89060, 94448, 89836, 77993, 81613, 86729, 81504, 95930, 85568, 84756, 89207, 82755, 91535, 82246, 81960, 110568, 76314, 110568, 90295, 78651, 88086, 101435, 94759, 78629, 110235, 77174, 86191, 96484, 90049, 93443, 79850, 80741, 106235, 88719, 92165, 74887, 99306, 70749, 86036, 95948, 90755, 91695, 97945, 85126, 97112, 110567, 88543, 107872, 91320, 92516, 92226, 66041, 85398, 84070, 107352, 90580, 84280, 93568, 79574, 96666, 87860, 90071, 84637, 90479, 87748, 87495, 91186, 82415, 84119, 86431, 88916, 80313, 87493, 88009, 85057, 69564, 99129, 80491, 109666, 84266, 71127, 82391, 84593, 89880, 85578, 87611, 91577, 87886, 84398, 91434, 91731, 99490, 83063, 82004, 84166, 79198, 85175, 83054, 83663, 86452, 89659, 66040]
thresholds = [75076, 85893, 98671]
display_name = "dFDA Maximum Trials per Year"
units = "trials/year"

# Calculate exceedance probabilities (1 - CDF)
sorted_samples = np.sort(samples)
exceedance = 1 - np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot exceedance curve
ax.plot(sorted_samples, exceedance * 100, color=COLOR_BLACK, linewidth=2.5)
ax.fill_between(sorted_samples, 0, exceedance * 100, alpha=0.1, color=COLOR_BLACK)

# Annotate thresholds
for thresh in thresholds:
    exceed_pct = (np.array(samples) >= thresh).sum() / len(samples) * 100
    ax.axvline(thresh, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
    ax.axhline(exceed_pct, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.3)
    
    # Add label
    ax.annotate(f'{exceed_pct:.0f}% chance\nâ‰¥ {thresh:,.2g}',
                xy=(thresh, exceed_pct), xytext=(thresh * 1.05, exceed_pct + 5),
                fontsize=10, ha='left', weight='bold',
                bbox=dict(boxstyle='round,pad=0.3', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, alpha=0.9))

ax.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=12)
ax.set_ylabel('Probability of Exceeding Value (%)', fontsize=12)
ax.set_title(f'Exceedance Probability: {display_name}', fontsize=14, weight='bold', pad=15)
ax.set_ylim(0, 100)
ax.set_xlim(left=min(sorted_samples) * 0.95)

clean_spines(ax)
add_watermark(fig)

# Save PNG
project_root = Path.cwd()
while project_root.name != 'decentralized-institutes-of-health' and project_root.parent != project_root:
    project_root = project_root.parent

output_path = project_root / 'knowledge' / 'figures' / 'exceedance-dfda_trials_per_year_capacity.png'
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Exceedance: {display_name}',
    description=f'Probability of {display_name} exceeding various thresholds'
)

plt.show()
```

*This exceedance probability chart shows the likelihood that dFDA Maximum Trials per Year will exceed any given threshold. Higher curves indicate more favorable outcomes with greater certainty.*
