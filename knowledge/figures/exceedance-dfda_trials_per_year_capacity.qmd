```{python}
#| echo: false
#| fig-cap: "Probability of Exceeding Threshold: dFDA Maximum Trials per Year"

import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines, get_tick_formatter,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
)
from dih_models.parameters import format_parameter_value

setup_chart_style()

# Monte Carlo samples

samples = [74346, 83392, 71647, 70526, 98041, 87487, 75445, 78277, 76356, 81840, 70885, 71485, 75833, 68605, 73349, 81883, 73953, 82562, 70890, 76566, 77428, 80680, 67420, 77234, 79008, 78510, 72956, 73973, 73683, 73573, 58686, 78864, 79559, 81574, 72451, 68584, 76974, 81753, 81647, 72243, 71690, 72890, 80577, 74795, 75515, 74879, 70932, 74848, 72074, 75824, 74443, 72359, 90001, 78299, 79284, 80400, 78010, 64142, 81927, 70364, 93792, 78398, 75227, 72630, 71881, 71393, 78488, 79231, 71011, 77469, 87064, 84827, 82292, 73169, 75354, 72005, 79001, 75254, 72393, 78232, 73414, 80553, 78581, 78703, 85803, 73231, 79277, 76171, 73269, 73477, 72155, 76875, 78975, 76756, 93869, 89836, 87816, 82825, 73762, 82197, 78680, 66480, 78537, 71724, 82389, 77560, 82501, 78425, 71115, 94557, 73551, 74761, 80102, 89819, 75795, 79673, 74792, 76112, 62900, 77779, 83141, 75124, 74871, 65755, 71146, 74025, 64514, 85692, 80405, 82341, 78756, 88687, 72336, 77668, 90226, 83021, 74292, 71128, 58687, 58686, 73673, 82772, 98136, 74575, 81569, 78923, 80221, 77146, 69379, 75263, 77260, 83326, 93652, 79389, 76591, 61016, 75430, 70279, 79474, 85632, 82605, 80977, 58686, 81626, 71126, 82180, 70578, 73853, 77247, 76508, 80506, 73480, 79183, 86271, 87100, 75166, 63162, 75244, 77004, 74463, 66398, 74875, 78894, 68869, 73585, 63664, 75100, 86253, 88549, 62337, 61512, 77394, 78712, 64536, 84421, 82124, 72287, 78787, 76282, 77291, 74144, 65176, 75679, 72283, 98093, 76559, 81774, 86164, 82011, 78393, 70670, 87875, 76056, 79374, 78351, 70163, 72921, 66018, 77233, 80781, 77679, 74731, 75141, 84072, 75680, 74820, 58686, 59855, 81842, 78089, 90105, 80079, 74279, 67626, 81003, 80501, 98201, 77286, 83735, 79673, 82002, 76848, 95084, 90164, 58686, 87251, 84263, 60251, 58686, 85423, 78615, 74120, 61456, 82754, 77817, 71488, 73549, 78667, 77101, 88658, 77771, 77953, 74795, 79844, 73325, 70058, 75273, 74057, 75914, 76249, 80953, 74274, 76868, 58686, 63228, 73848, 81232, 84504, 67808, 74606, 73272, 94856, 70603, 73429, 84473, 79291, 74600, 75919, 78120, 76907, 77860, 75291, 64418, 98268, 77763, 75141, 74400, 78639, 95067, 74203, 61471, 91272, 70976, 78356, 76639, 83589, 78395, 66470, 72652, 61415, 67979, 73522, 61285, 73523, 71188, 78149, 75830, 80791, 70240, 85528, 71458, 77465, 68055, 71645, 60430, 71764, 91911, 76674, 85429, 79599, 63951, 72322, 80801, 82992, 76043, 86128, 80615, 74301, 68254, 72494, 98267, 74349, 75796, 73676, 62734, 98100, 80082, 72602, 92072, 64365, 73955, 71078, 79948, 71272, 69347, 74791, 74781, 74559, 81910, 77189, 77221, 73863, 70180, 83675, 77045, 64300, 81101, 81632, 74981, 71091, 76178, 66120, 71018, 71106, 72824, 58686, 77559, 98069, 62871, 79200, 75570, 66355, 92421, 86682, 92404, 81442, 73519, 73005, 74522, 89274, 98267, 75907, 79293, 73399, 71936, 75380, 71590, 74814, 72969, 80839, 77394, 75015, 71232, 78781, 73023, 77950, 76997, 71179, 98063, 87396, 90414, 98267, 80663, 71653, 78073, 75009, 69084, 66135, 76688, 65822, 75669, 81734, 80103, 90387, 82079, 78548, 71332, 61545, 88776, 73805, 83401, 73305, 77083, 96364, 70598, 80174, 79703, 83847, 80502, 73591, 77456, 74199, 73994, 66220, 78449, 90326, 69363, 78376, 68764, 73863, 77084, 74075, 59071, 58686, 75812, 75243, 69249, 81790, 74172, 76414, 74290, 81707, 92206, 98105, 84581, 79207, 78127, 59216, 68873, 82584, 74082, 78869, 78070, 75087, 72432, 78426, 69406, 84961, 76210, 58686, 74852, 64870, 75673, 72663, 76610, 77335, 81343, 73576, 81830, 72153, 69134, 73966, 78082, 73432, 78227, 70555, 96373, 78402, 98062, 90627, 65699, 70792, 80939, 90750, 98268, 79766, 58686, 73548, 79872, 73364, 91725, 78154, 75623, 76796, 71408, 74101, 72137, 80730, 70776, 62588, 82639, 82076, 66037, 77470, 65220, 79101, 64612, 75423, 74634, 63328, 78573, 82440, 79140, 73441, 91806, 72322, 79735, 68348, 98268, 81390, 93854, 81659, 74699, 77392, 77869, 77263, 74974, 82914, 71907, 72171, 73853, 72809, 74398, 58687, 76803, 78217, 81168, 83274, 86569, 82083, 76698, 74164, 75927, 81249, 70763, 71713, 77266, 80493, 72858, 75070, 89853, 76681, 74610, 82158, 75058, 89963, 66032, 67107, 77864, 73985, 98268, 85185, 78131, 83884, 71862, 58687, 85501, 81735, 74775, 62793, 86220, 74691, 60423, 93261, 87150, 78977, 79615, 71279, 74736, 95384, 73058, 79992, 66782, 80324, 80384, 72902, 71573, 73467, 93839, 72921, 83305, 74776, 89453, 73478, 81526, 87175, 71865, 74737, 80234, 64657, 79088, 76047, 74568, 80272, 73327, 79700, 78898, 65713, 83401, 98268, 62795, 58686, 78857, 98034, 78239, 78082, 77461, 84519, 72670, 73003, 90616, 71953, 58687, 75170, 78414, 77153, 72455, 94615, 75217, 78760, 60164, 77359, 62144, 84370, 72624, 74256, 81949, 75136, 67543, 78326, 93948, 76361, 82176, 78446, 76768, 94184, 92647, 73261, 79629, 98268, 71443, 74546, 80901, 87722, 71142, 74072, 58686, 73638, 73836, 77313, 71254, 72396, 67061, 79619, 79054, 79341, 71408, 64101, 79208, 78984, 74289, 77820, 70459, 98267, 81662, 81362, 98267, 82594, 82263, 77533, 68785, 77816, 83252, 76611, 69592, 82679, 82232, 72797, 77664, 72262, 76336, 71938, 83317, 76326, 77594, 86118, 91768, 72033, 78502, 83122, 76861, 68596, 98267, 90653, 82316, 64539, 74483, 71547, 84933, 84614, 73469, 75882, 72856, 77446, 74511, 75256, 71485, 71312, 92719, 98267, 70169, 67850, 83097, 96875, 75626, 70583, 60686, 73053, 78638, 82113, 76177, 78166, 83013, 58687, 60824, 68495, 82302, 71028, 72309, 73501, 67086, 72335, 71709, 72325, 74124, 95535, 75723, 79850, 87130, 61985, 61452, 65755, 74652, 65858, 76174, 74978, 84212, 73779, 75869, 87495, 76574, 76756, 60686, 70798, 76177, 74692, 75971, 77544, 84042, 77211, 81118, 86661, 73084, 73815, 95589, 77030, 70204, 69464, 69890, 76004, 81786, 84061, 74101, 73888, 66625, 68948, 77091, 86565, 78295, 74888, 77539, 79994, 74667, 79505, 80327, 74305, 78835, 74721, 74541, 84922, 79355, 64816, 85275, 98128, 96910, 76066, 76055, 76997, 67523, 98268, 73786, 63366, 84741, 78690, 81163, 82121, 78342, 64938, 60246, 78405, 59555, 76025, 61175, 76842, 75425, 73973, 58686, 71050, 80857, 70360, 78573, 79411, 70713, 76053, 74508, 76161, 74150, 73608, 98034, 72148, 82720, 89757, 76620, 75720, 80765, 71170, 88129, 78868, 80040, 76545, 74506, 82904, 71803, 75852, 97445, 98045, 76328, 77660, 76907, 76427, 74836, 70484, 84483, 85429, 84209, 74444, 67144, 79027, 98268, 94155, 81705, 79860, 78877, 76006, 78247, 69590, 80648, 81903, 73280, 91302, 73824, 75604, 77188, 63056, 80288, 58687, 77689, 87085, 75809, 83947, 81156, 73779, 72815, 80288, 70252, 68227, 64834, 72973, 65704, 97246, 78287, 81935, 75499, 79951, 77308, 59798, 77331, 73677, 77733, 75772, 76212, 73466, 68129, 62377, 74316, 72610, 85100, 76808, 70527, 70964, 74923, 70844, 73208, 67694, 74441, 78533, 74155, 98268, 73866, 98268, 94491, 73445, 73288, 85280, 80889, 65618, 79374, 58686, 76262, 73712, 62726, 75426, 82860, 76947, 76475, 88493, 77885, 81091, 70621, 76031, 78060, 76924, 74851, 72446, 82842, 83416, 68889, 78903, 89340, 73493, 73374, 91220, 74812, 71736, 73918, 72355, 89135, 74184, 78188, 79365, 70937, 64326, 60722, 66291, 76947, 74051, 71550, 75487, 75427, 71213, 76626, 81005, 78917, 72343, 76231, 74128, 72127, 78658, 71613, 73891, 86416, 64762, 79484, 93317, 83469, 83104, 75921, 78002, 78410, 72429, 74130, 74277, 73701, 72450, 98124, 78590, 98267, 76022, 76279, 69639, 67852, 74978, 79481, 73242, 79663, 76259, 70260, 79860, 71320, 72083, 82534, 70331, 71956, 75608, 81227, 81882, 79727, 72894, 82540, 73532, 86526, 77552, 75559, 58686, 88697, 64411, 75308, 73693, 75505, 73488, 77228, 64623, 79192, 68543, 80436, 76632, 83881, 73425, 64729, 76741, 77505, 84538, 77714, 92261, 82248, 74829, 66240, 58686, 80052, 64846, 74723, 77213, 73562, 75859, 75555, 78877, 89035, 91435, 72227, 78020, 80115, 76196, 71383, 75117, 80514, 67373, 63161, 73185, 70332, 67181, 68570, 72462, 72557, 73032, 84271, 71943, 88349, 81445, 66428, 71116, 64230, 77988, 85121, 77786, 75607, 75752, 68525, 78569, 74055, 82766, 73454, 76230, 81143, 77756, 77424, 77978, 60978, 76875, 77808, 98118, 82120, 77932, 80713, 65485, 77300, 66612, 75861, 76015, 76814, 76226, 61567, 98267, 98068, 79764, 76158, 72007, 73315, 78719, 69977, 69834, 75094, 70397, 74545, 79885, 71961, 75553, 76241, 64400, 98268, 89354, 85665, 78582, 77877, 90830, 82742, 81893, 58686, 60640, 78899, 78585, 85074, 97733, 76993, 82829, 76788, 92386, 81225, 75315, 73968, 73654, 87780, 71030, 81483, 72350, 76317, 88682, 78276, 73973, 72469, 77147, 63711, 70125, 77891, 71649, 59252, 58972, 86309, 82341, 64259, 83671, 87813, 79388, 73637, 76900, 80477, 80636, 80891, 82020, 58686, 74391, 70841, 79407, 77435, 80899, 98268, 88708, 96007, 98267, 85795, 66168, 76531, 66586, 73694, 71457, 82166, 73006, 71777, 79986, 72791, 72751, 79806, 84664, 85619, 75705, 74209, 81431, 76082, 72725, 72438, 63477, 66751, 82853, 61965, 79683, 69647, 75821, 78902, 95956, 77343, 91699, 70370, 63886, 81460, 74363, 80979, 80330, 71504, 76494, 61333, 79362, 70183, 75636, 71378, 79131, 76564, 76984, 81725, 72174, 72245, 72586, 63650, 64679, 78659, 73926, 80298, 76102, 80139, 62690, 73984, 77641, 67777, 98267, 98075, 71378, 75868, 74682, 87875, 76397, 58687, 71210, 75184, 79078, 78787, 98135, 74637, 71084, 91972, 80550, 85203, 82606, 75912, 98111, 72461, 71627, 77855, 98268, 82819, 67292, 98268, 78480, 85554, 71326, 80642, 73737, 72755, 60258, 77544, 73908, 90461, 67817, 81215, 79880, 76391, 91758, 74816, 70369, 74419, 92195, 77037, 71697, 97197, 83924, 70901, 74560, 73688, 60039, 73343, 72200, 58686, 77614, 81467, 73591, 73523, 79655, 83276, 58686, 74210, 81025, 70670, 76943, 77866, 72775, 87322, 74052, 59472, 73357, 78667, 79526, 78890, 77873, 78677, 70668, 94659, 70987, 78690, 73902, 84729, 66124, 67135, 70415, 90954, 71181, 73731, 92471, 76404, 73978, 72812, 75137, 74430, 64393, 67377, 98268, 78284, 77298, 94986, 75656, 67097, 84105, 74151, 82268, 80620, 64348, 79760, 73381, 97076, 60009, 72531, 77413, 72695, 89226, 67915, 78327, 77552, 79424, 80012, 71980, 74648, 72236, 76305, 73072, 78946, 58686, 91842, 66948, 65650, 81834, 58686, 70205, 70347, 76073, 77636, 77586, 73819, 65252, 75112, 82238, 71209, 70640, 72219, 71677, 77983, 82357, 81943, 92983, 74766, 76779, 79084, 98268, 86614, 68686, 80571, 74003, 88914, 64805, 77166, 74437, 58686, 63890, 78214, 80096, 78337, 73092, 76918, 78791, 64468, 76976, 58686, 75678, 60822, 74023, 70395, 80973, 81845, 73397, 70246, 75996, 87235, 88421, 89509, 95256, 75560, 68633, 76335, 98267, 77466, 77287, 58686, 90001, 78761, 61713, 73456, 72768, 75528, 74191, 71486, 81545, 70893, 88627, 74201, 75128, 80249, 76393, 80291, 83877, 78520, 84374, 74235, 85088, 71876, 85578, 79917, 80304, 66166, 74189, 77601, 73159, 98123, 76523, 58687, 75417, 75821, 72860, 70789, 98066, 93783, 74931, 80908, 66325, 78270, 98032, 86942, 98268, 77745, 77451, 78982, 69215, 67717, 77335, 98138, 72443, 72816, 74318, 70287, 85317, 58687, 82566, 71655, 93869, 82366, 63891, 77918, 71117, 74766, 76917, 65699, 77761, 95485, 81503, 72842, 73789, 91828, 80971, 80019, 78597, 88674, 80330, 81000, 71522, 71299, 77178, 78770, 75370, 81593, 85037, 82434, 80372, 85296, 75232, 71771, 92165, 76091, 77654, 74120, 76332, 89943, 86853, 76064, 69852, 98267, 74094, 67827, 77224, 72848, 80829, 77009, 92736, 98267, 70513, 82741, 79186, 88845, 89228, 77357, 81007, 73896, 73440, 74247, 74755, 63177, 83814, 76598, 68537, 66904, 89421, 78251, 65768, 73103, 75025, 77639, 78716, 74448, 77863, 76520, 75754, 80661, 72957, 58686, 95419, 74228, 81213, 72683, 75956, 71579, 68002, 75042, 68545, 98267, 63030, 73914, 69228, 86180, 81689, 75332, 76358, 74480, 69144, 95214, 70331, 76197, 77550, 90231, 73133, 98268, 72256, 90578, 75912, 77007, 68077, 77388, 80769, 79522, 66802, 72932, 78728, 77760, 91830, 73832, 95120, 71639, 75441, 58686, 84314, 76902, 60678, 67805, 80783, 74846, 76237, 74487, 80799, 76817, 92349, 75400, 73456, 77702, 92637, 70246, 73978, 80983, 78045, 90720, 83170, 79728, 67347, 80404, 72306, 79732, 74697, 77149, 70922, 79709, 91920, 88772, 79689, 86641, 73699, 79253, 58686, 94737, 74973, 84744, 79435, 75361, 98267, 74766, 59578, 79172, 74624, 69902, 77294, 80014, 98267, 72301, 76969, 82977, 75453, 80032, 79666, 72509, 88068, 69616, 89028, 80559, 59366, 68604, 75635, 82436, 79672, 75788, 76013, 76827, 76445, 77618, 89752, 79588, 70678, 88552, 77458, 81615, 75549, 78748, 64348, 73112, 87641, 72120, 81310, 79988, 74290, 79424, 70806, 81309, 80267, 80516, 79913, 68958, 72374, 61667, 58686, 83251, 75806, 85495, 81330, 80341, 83654, 83574, 77168, 86131, 71104, 82281, 58686, 79159, 75796, 87378, 61711, 68703, 74395, 88204, 74929, 84643, 64525, 71299, 75649, 98268, 82730, 72021, 67539, 68833, 92248, 74366, 70022, 93373, 76300, 74537, 78176, 96739, 78338, 78348, 77192, 79898, 79104, 76501, 73502, 78200, 78885, 75668, 97962, 73291, 76253, 75999, 70408, 98042, 98053, 74537, 76295, 75181, 79229, 72161, 70572, 73249, 77918, 98124, 71536, 67430, 72279, 82021, 72104, 70996, 63396, 81997, 77696, 71666, 75888, 84580, 73672, 72676, 75695, 74873, 77904, 64338, 82164, 80056, 76180, 70887, 90665, 87617, 98087, 76043, 84595, 78721, 72179, 80417, 74801, 78167, 72114, 73303, 80754, 77324, 69661, 73802, 89016, 72213, 84075, 65116, 69912, 74438, 75262, 77584, 72076, 78631, 74774, 70929, 79887, 80248, 85779, 83766, 96320, 71770, 60560, 64964, 92824, 71800, 65002, 79195, 75611, 98071, 74581, 83752, 74997, 91729, 72892, 69907, 81368, 84883, 98267, 77954, 80018, 91559, 73437, 79150, 83939, 79839, 69311, 72530, 77077, 72432, 85256, 76045, 75324, 79280, 73544, 81349, 73092, 72838, 98268, 67818, 98268, 80247, 69896, 78283, 90150, 84216, 69876, 97972, 68583, 76599, 85749, 80029, 83046, 70962, 71754, 94416, 78846, 81909, 66550, 88257, 62872, 76461, 85272, 80656, 81492, 87047, 75652, 86307, 98267, 78689, 95871, 81158, 82222, 81964, 58687, 75894, 74713, 95409, 80500, 74900, 83157, 70716, 85910, 78083, 80048, 75217, 80410, 77983, 77758, 81039, 73242, 74757, 76812, 79022, 71374, 77756, 78215, 75590, 61818, 88100, 71532, 97467, 74888, 63208, 73220, 75178, 79878, 76054, 77861, 81386, 78106, 75005, 81260, 81524, 88421, 73818, 72877, 74798, 70382, 75696, 73810, 74352, 76831, 79682, 58686]
thresholds = [66718, 76334, 87693]
display_name = "dFDA Maximum Trials per Year"
units = "trials/year"

# Calculate exceedance probabilities (1 - CDF)

sorted_samples = np.sort(samples)
exceedance = 1 - np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

# Create figure

fig, ax = plt.subplots(figsize=(10, 6))

# Plot exceedance curve

ax.plot(sorted_samples, exceedance * 100, color=COLOR_BLACK, linewidth=2.5)
ax.fill_between(sorted_samples, 0, exceedance * 100, alpha=0.1, color=COLOR_BLACK)

# Apply tick formatter for readable labels (K, M, B suffixes, $ for USD)

ax.xaxis.set_major_formatter(get_tick_formatter(unit=units))

# Annotate thresholds

for thresh in thresholds:
    exceed_pct = (np.array(samples) >= thresh).sum() / len(samples) * 100
    ax.axvline(thresh, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
    ax.axhline(exceed_pct, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.3)

    # Add label with formatted threshold value (use format_parameter_value for full units)

    ax.annotate(f'{exceed_pct:.0f}% chance\nâ‰¥ {format_parameter_value(thresh, units)}',
                xy=(thresh, exceed_pct), xytext=(thresh * 1.05, exceed_pct + 5),
                fontsize=10, ha='left', weight='bold',
                bbox=dict(boxstyle='round,pad=0.3', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, alpha=0.9))

ax.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=12)
ax.set_ylabel('Probability of Exceeding Value (%)', fontsize=12)
ax.set_title(f'Exceedance Probability: {display_name}', fontsize=14, weight='bold', pad=15)
ax.set_ylim(0, 100)
ax.set_xlim(left=min(sorted_samples) * 0.95)

clean_spines(ax)
add_watermark(fig)

# Save PNG to knowledge/figures/ regardless of where Quarto renders from

output_path = get_figure_output_path('exceedance-dfda_trials_per_year_capacity.png')
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Exceedance: {display_name}',
    description=f'Probability of {display_name} exceeding various thresholds'
)

plt.show()
```

*This exceedance probability chart shows the likelihood that dFDA Maximum Trials per Year will exceed any given threshold. Higher curves indicate more favorable outcomes with greater certainty.*
