```{python}
#| echo: false
from dih_models.parameters import *
```

```{python}
#| fig-height: 6
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, PATTERN_DIAGONAL,
    add_png_metadata, get_figure_output_path)

# Setup minimalist styling

setup_chart_style(dpi=150)

# Create figure

fig, ax = plt.subplots(figsize=(12, 6))

# Data

categories = ['War on\nHumanity', 'War on Disease']
# Convert parameters to billions for chart display

BILLION = 1_000_000_000

military_total = float(GLOBAL_MILITARY_SPENDING_ANNUAL_2024) / BILLION
cure_spending = float(GLOBAL_MED_RESEARCH_SPENDING) / BILLION
treaty_funding = float(TREATY_ANNUAL_FUNDING) / BILLION

# Make the 1% stack visually prominent (exaggerate it to ~100B so it's actually visible)

visual_stack_height = 100  # Visual height for the 1% slice (much larger than actual ~$27B from TREATY_ANNUAL_FUNDING)
military_99_visual = military_total - visual_stack_height

# Create stacked bar for military spending

x_positions = [0, 1]
bar_width = 0.8

# War on Humanity - stacked bar (lower part solid black, top part with diagonal pattern)

bar_99 = ax.bar(x_positions[0], military_99_visual, bar_width,
                color=COLOR_BLACK, edgecolor=COLOR_BLACK, linewidth=2)
bar_1 = ax.bar(x_positions[0], visual_stack_height, bar_width, bottom=military_99_visual,
               color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=2, hatch='////')

# War on Disease - solid black bar

bar_cure = ax.bar(x_positions[1], cure_spending, bar_width,
                  color=COLOR_BLACK, edgecolor=COLOR_BLACK, linewidth=2)

# Add custom labels
# Main label inside the 99% bar (white text on black)

ax.text(x_positions[0], military_99_visual * 0.6,
        f'${military_total/1000:.1f}T', ha='center', va='center',
        color=COLOR_WHITE, fontsize=72, fontweight='bold')
ax.text(x_positions[0], military_99_visual * 0.35,
        categories[0], ha='center', va='center',
        color=COLOR_WHITE, fontsize=44, fontweight='bold')

# Annotation text box positioned between the bars

annotation_x = 0.9  # Center between the two bars
annotation_y = 1800  # Middle height

ax.text(annotation_x, annotation_y,
        f'A 1% treaty would\nredirect this tiny sliver\n(${treaty_funding:.0f}B) to the\nWar on Disease',
        fontsize=20, fontweight='bold', color=COLOR_BLACK,
        ha='center', va='center',
        bbox=dict(boxstyle='square,pad=0.6', facecolor=COLOR_WHITE,
                 edgecolor=COLOR_BLACK, linewidth=2))

# Fat arrow pointing from "War on Humanity" bar to the annotation

arrow1_start_x = x_positions[0] + bar_width / 2 + 0.00
arrow1_start_y = military_99_visual + (visual_stack_height / 2)
arrow1_end_x = annotation_x - 0.35  # Adjusted to point to the right (25% shorter)
arrow1_end_y = min(annotation_y + 362.5, 2900 * 0.95)  # Clipped to ylim

ax.annotate('',
            xy=(arrow1_end_x, arrow1_end_y),
            xytext=(arrow1_start_x, arrow1_start_y),
            arrowprops=dict(arrowstyle='->', lw=6, color=COLOR_BLACK,
                          mutation_scale=30, shrinkA=5, shrinkB=5))

# Fat arrow pointing from annotation to "War on Disease" bar

arrow2_start_x = annotation_x
arrow2_start_y = annotation_y - 445  # Moved arrow up by 1/3 of its length
arrow2_end_x = x_positions[1] - 0.025  # 25% shorter
arrow2_end_y = min(cure_spending + 947.25, 2900 * 0.95)  # Clipped to ylim

ax.annotate('',
            xy=(arrow2_end_x, arrow2_end_y),
            xytext=(arrow2_start_x, arrow2_start_y),
            arrowprops=dict(arrowstyle='->', lw=6, color=COLOR_BLACK,
                          mutation_scale=30, shrinkA=5, shrinkB=5))

# Label above small bar (clipped to ylim to avoid bbox calculation issues)

label_y = min(cure_spending + (military_total * 0.025), 2900 * 0.95)  # Ensure within ylim
ax.text(x_positions[1], label_y,
        f'${cure_spending}B\n{categories[1]}', ha='center', va='bottom',
        color=COLOR_BLACK, fontsize=44, fontweight='bold', linespacing=1.2)

# Set x-axis with category labels

ax.set_xticks(x_positions)
ax.set_xticklabels(['', ''])  # We'll keep labels on the bars themselves

ax.set_ylim(0, 2900)

# Remove axes manually (instead of ax.axis('off') to avoid bbox calculation issues)

ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
ax.spines['bottom'].set_visible(False)
ax.spines['left'].set_visible(False)
ax.tick_params(left=False, bottom=False, labelleft=False, labelbottom=False)

# Add watermark

add_watermark(fig)

# Save in brain/figures directory

output_path = get_figure_output_path('military-vs-medical-research-spending-1-percent-treaty-column-chart.png')

# Save the figure
# NOTE: Using bbox_inches='tight' instead of None due to matplotlib bbox calculation bug
# when annotations extend beyond plot area. This is an exception to DESIGN_GUIDE.md.
# The design guide recommends bbox_inches=None, but it fails with this chart's annotations.

fig.savefig(output_path, dpi=300, bbox_inches='tight', facecolor=COLOR_WHITE)

# Add metadata for attribution

add_png_metadata(output_path, title="Military Vs Medical Research Spending 1 Percent Treaty Column Chart")
plt.show()

```
