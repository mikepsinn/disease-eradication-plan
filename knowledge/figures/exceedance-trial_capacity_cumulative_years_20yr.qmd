```{python}
#| echo: false
#| fig-cap: "Probability of Exceeding Threshold: Cumulative Trial Capacity Years Over 20 Years"
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines, get_tick_formatter,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
)
from dih_models.parameters import format_parameter_value

setup_chart_style()

# Monte Carlo samples
samples = [439, 564, 404, 390, 728, 608, 453, 492, 465, 543, 394, 402, 458, 372, 426, 544, 433, 554, 394, 468, 480, 526, 362, 477, 502, 495, 421, 434, 430, 428, 296, 500, 510, 539, 414, 372, 474, 542, 540, 411, 404, 420, 525, 445, 454, 446, 395, 445, 409, 458, 440, 413, 635, 492, 506, 522, 488, 335, 545, 388, 678, 494, 450, 416, 407, 401, 495, 505, 396, 481, 603, 579, 550, 423, 452, 408, 502, 451, 413, 491, 426, 524, 496, 498, 590, 424, 506, 463, 425, 427, 410, 473, 502, 471, 679, 634, 612, 558, 431, 549, 498, 354, 496, 405, 551, 482, 553, 494, 397, 686, 428, 444, 518, 633, 458, 512, 444, 462, 325, 485, 562, 449, 446, 348, 398, 434, 338, 589, 522, 551, 499, 621, 413, 483, 638, 560, 438, 397, 296, 296, 430, 557, 742, 442, 539, 501, 520, 476, 379, 451, 478, 564, 676, 508, 469, 310, 453, 387, 509, 588, 555, 531, 296, 540, 397, 548, 391, 432, 478, 468, 524, 427, 505, 595, 604, 449, 327, 450, 474, 440, 354, 446, 501, 374, 429, 331, 449, 595, 620, 321, 314, 480, 498, 338, 575, 548, 412, 499, 464, 478, 436, 344, 456, 412, 736, 468, 542, 594, 546, 494, 392, 612, 461, 507, 493, 385, 420, 351, 477, 528, 484, 444, 449, 571, 456, 445, 296, 302, 543, 489, 637, 518, 438, 364, 531, 524, 743, 478, 568, 512, 546, 472, 692, 637, 296, 605, 573, 304, 296, 586, 497, 436, 313, 557, 486, 402, 428, 497, 476, 621, 485, 487, 445, 514, 425, 385, 451, 435, 459, 464, 530, 438, 472, 296, 328, 432, 534, 576, 365, 442, 425, 690, 391, 427, 576, 506, 442, 460, 490, 473, 486, 451, 337, 744, 485, 449, 439, 497, 692, 437, 314, 649, 396, 493, 469, 566, 494, 354, 417, 313, 367, 428, 312, 428, 398, 490, 458, 528, 386, 587, 402, 481, 368, 404, 305, 405, 657, 470, 586, 511, 334, 412, 528, 560, 461, 593, 525, 438, 369, 415, 744, 439, 458, 430, 324, 737, 518, 416, 658, 337, 433, 397, 516, 399, 378, 444, 444, 441, 544, 477, 477, 432, 386, 567, 475, 336, 532, 540, 447, 397, 463, 351, 396, 397, 419, 296, 482, 732, 325, 505, 455, 353, 662, 599, 662, 537, 428, 421, 441, 627, 744, 459, 506, 426, 408, 452, 403, 445, 421, 529, 480, 447, 399, 499, 421, 487, 474, 398, 731, 607, 640, 744, 526, 404, 489, 447, 376, 351, 470, 349, 456, 542, 518, 640, 547, 496, 400, 314, 622, 432, 564, 425, 475, 707, 391, 519, 512, 569, 524, 429, 481, 437, 434, 352, 494, 639, 379, 493, 373, 432, 475, 435, 298, 296, 458, 450, 378, 543, 436, 466, 438, 541, 660, 738, 577, 505, 490, 299, 374, 554, 435, 500, 489, 448, 414, 494, 379, 581, 463, 296, 445, 341, 456, 417, 469, 479, 536, 429, 543, 410, 377, 434, 489, 427, 491, 390, 707, 494, 731, 642, 348, 393, 530, 644, 744, 513, 296, 428, 515, 426, 655, 490, 456, 471, 401, 435, 410, 527, 393, 323, 555, 547, 351, 481, 344, 504, 339, 453, 442, 329, 496, 552, 504, 427, 655, 412, 513, 370, 744, 537, 678, 541, 443, 480, 486, 478, 447, 559, 407, 410, 432, 419, 439, 296, 472, 491, 533, 563, 598, 547, 470, 436, 460, 535, 393, 405, 478, 524, 419, 448, 634, 470, 442, 548, 448, 635, 351, 360, 486, 434, 744, 583, 490, 569, 407, 296, 587, 542, 444, 324, 594, 443, 305, 672, 604, 502, 511, 399, 444, 696, 422, 516, 357, 521, 522, 420, 403, 427, 678, 420, 563, 444, 629, 427, 539, 605, 407, 444, 520, 339, 503, 461, 442, 520, 425, 512, 501, 348, 564, 744, 324, 296, 500, 727, 491, 489, 481, 576, 417, 421, 642, 408, 296, 449, 494, 476, 414, 687, 450, 499, 303, 479, 319, 575, 416, 437, 545, 449, 363, 493, 679, 466, 548, 494, 471, 682, 665, 424, 511, 744, 401, 441, 530, 611, 398, 435, 296, 429, 432, 479, 399, 413, 359, 511, 503, 507, 401, 335, 505, 502, 438, 486, 389, 744, 541, 536, 744, 555, 550, 482, 374, 486, 563, 469, 381, 556, 549, 418, 483, 412, 465, 408, 563, 465, 482, 593, 655, 409, 495, 561, 472, 372, 744, 643, 550, 338, 440, 403, 581, 577, 427, 459, 419, 480, 441, 451, 402, 400, 666, 744, 386, 366, 561, 713, 456, 391, 307, 422, 497, 547, 463, 490, 560, 296, 308, 371, 550, 396, 412, 428, 359, 413, 405, 412, 436, 697, 457, 514, 604, 318, 313, 348, 443, 349, 463, 447, 573, 431, 459, 608, 468, 471, 307, 393, 463, 443, 460, 482, 571, 477, 533, 599, 422, 432, 698, 475, 386, 379, 383, 461, 542, 571, 435, 433, 356, 375, 476, 598, 492, 446, 482, 516, 443, 509, 521, 438, 500, 444, 441, 580, 507, 341, 584, 741, 713, 462, 461, 474, 363, 744, 431, 329, 579, 498, 533, 547, 493, 342, 304, 494, 300, 461, 311, 472, 453, 434, 296, 396, 529, 388, 496, 508, 392, 461, 441, 463, 436, 429, 727, 410, 556, 633, 469, 457, 528, 398, 615, 500, 517, 468, 441, 559, 406, 459, 719, 729, 465, 483, 473, 466, 445, 389, 576, 586, 573, 440, 360, 503, 744, 682, 541, 514, 500, 461, 492, 381, 526, 544, 425, 650, 432, 455, 477, 326, 521, 296, 484, 604, 458, 570, 533, 431, 419, 521, 387, 369, 341, 421, 348, 717, 492, 545, 454, 516, 479, 302, 479, 430, 484, 458, 464, 427, 368, 321, 438, 416, 582, 472, 390, 395, 446, 394, 424, 364, 440, 496, 436, 744, 432, 744, 686, 427, 425, 584, 529, 347, 507, 296, 464, 430, 324, 453, 559, 474, 467, 619, 487, 532, 391, 461, 489, 473, 445, 414, 558, 565, 375, 501, 628, 427, 426, 649, 445, 405, 433, 413, 626, 436, 491, 507, 395, 337, 308, 353, 474, 435, 403, 454, 453, 398, 469, 531, 501, 413, 464, 436, 410, 497, 403, 433, 596, 340, 509, 672, 565, 561, 460, 488, 494, 414, 436, 438, 430, 414, 740, 496, 744, 461, 464, 381, 366, 447, 509, 424, 512, 464, 387, 514, 400, 409, 554, 388, 408, 455, 534, 544, 513, 420, 554, 428, 598, 482, 455, 296, 621, 337, 451, 430, 454, 427, 477, 339, 505, 372, 523, 469, 569, 427, 340, 471, 481, 576, 484, 660, 549, 445, 352, 296, 517, 341, 444, 477, 428, 459, 455, 500, 625, 651, 411, 488, 518, 463, 401, 449, 524, 362, 327, 423, 388, 360, 372, 414, 415, 422, 574, 408, 617, 537, 354, 397, 336, 488, 583, 485, 455, 457, 371, 496, 435, 557, 427, 464, 533, 485, 480, 488, 310, 473, 485, 739, 547, 487, 527, 346, 478, 355, 459, 461, 472, 464, 314, 744, 732, 513, 463, 408, 425, 498, 384, 383, 448, 388, 441, 515, 408, 455, 464, 337, 744, 628, 588, 496, 486, 645, 557, 544, 296, 307, 501, 496, 582, 723, 474, 558, 471, 662, 534, 451, 434, 430, 611, 396, 538, 413, 465, 621, 492, 434, 414, 476, 332, 385, 487, 404, 299, 297, 595, 551, 336, 567, 612, 508, 429, 473, 523, 526, 529, 546, 296, 439, 394, 508, 480, 529, 744, 621, 703, 744, 590, 352, 468, 355, 430, 401, 548, 421, 406, 516, 418, 418, 514, 578, 588, 457, 437, 537, 462, 418, 414, 330, 357, 558, 318, 512, 381, 458, 501, 702, 479, 654, 388, 333, 538, 439, 531, 521, 402, 467, 313, 507, 386, 456, 401, 504, 468, 474, 542, 411, 411, 416, 331, 339, 497, 433, 521, 462, 518, 323, 434, 483, 365, 744, 733, 401, 459, 443, 612, 466, 296, 398, 450, 503, 499, 742, 442, 397, 657, 524, 583, 555, 459, 738, 414, 404, 486, 744, 558, 361, 744, 495, 587, 400, 526, 431, 418, 304, 482, 433, 641, 366, 534, 515, 466, 655, 445, 388, 440, 660, 475, 405, 716, 570, 395, 441, 430, 303, 426, 411, 296, 483, 538, 429, 428, 511, 563, 296, 437, 531, 392, 473, 486, 418, 606, 435, 300, 426, 497, 510, 501, 486, 498, 392, 687, 396, 498, 433, 578, 351, 360, 389, 646, 398, 431, 663, 466, 434, 419, 449, 440, 337, 362, 744, 492, 478, 691, 456, 359, 572, 436, 550, 525, 337, 513, 426, 715, 303, 415, 480, 417, 627, 366, 493, 482, 508, 517, 408, 443, 411, 465, 422, 501, 296, 656, 358, 347, 543, 296, 386, 388, 462, 483, 482, 432, 344, 449, 549, 398, 391, 411, 404, 488, 551, 545, 669, 444, 471, 503, 744, 599, 373, 525, 434, 624, 341, 477, 440, 296, 333, 491, 518, 493, 422, 473, 499, 338, 474, 296, 456, 308, 434, 388, 531, 543, 426, 386, 461, 605, 618, 630, 694, 455, 372, 465, 744, 481, 478, 296, 635, 499, 316, 427, 418, 454, 437, 402, 539, 394, 620, 437, 449, 520, 466, 521, 569, 495, 575, 437, 582, 407, 587, 515, 521, 352, 437, 483, 423, 740, 468, 296, 453, 458, 419, 393, 732, 678, 446, 530, 353, 492, 727, 602, 744, 485, 480, 502, 377, 365, 479, 742, 414, 419, 438, 387, 585, 296, 554, 404, 679, 551, 333, 487, 397, 444, 473, 348, 485, 697, 538, 419, 431, 656, 531, 517, 496, 621, 521, 531, 402, 400, 477, 499, 452, 540, 582, 552, 522, 584, 450, 405, 659, 462, 483, 436, 465, 635, 601, 462, 383, 744, 435, 366, 477, 419, 528, 474, 666, 744, 390, 557, 505, 623, 627, 479, 531, 433, 427, 437, 444, 327, 569, 469, 372, 358, 629, 492, 348, 422, 448, 483, 498, 440, 486, 468, 457, 526, 421, 296, 696, 437, 534, 417, 460, 403, 367, 448, 372, 744, 326, 433, 377, 594, 541, 452, 465, 440, 377, 694, 388, 463, 482, 638, 423, 744, 412, 642, 459, 474, 368, 480, 528, 510, 357, 420, 498, 485, 656, 432, 693, 404, 453, 296, 574, 473, 307, 365, 528, 445, 464, 440, 528, 472, 661, 453, 427, 484, 665, 386, 434, 531, 489, 643, 562, 513, 362, 522, 412, 513, 443, 476, 395, 512, 657, 622, 512, 599, 430, 506, 296, 688, 447, 579, 508, 452, 744, 444, 300, 505, 442, 383, 478, 517, 744, 412, 474, 560, 453, 517, 512, 415, 614, 381, 625, 525, 299, 372, 456, 552, 512, 458, 461, 472, 467, 483, 633, 511, 392, 620, 481, 540, 455, 499, 337, 423, 610, 410, 535, 516, 438, 508, 393, 535, 520, 524, 515, 375, 413, 315, 296, 563, 458, 587, 536, 521, 567, 566, 477, 593, 397, 550, 296, 504, 458, 607, 316, 373, 439, 616, 446, 578, 338, 400, 456, 744, 557, 409, 363, 374, 660, 439, 384, 673, 465, 441, 491, 711, 493, 493, 477, 515, 504, 467, 428, 491, 501, 456, 725, 425, 464, 461, 388, 728, 730, 441, 465, 450, 505, 410, 391, 424, 487, 740, 402, 362, 412, 546, 410, 396, 329, 546, 484, 404, 459, 577, 430, 417, 457, 446, 487, 337, 548, 517, 463, 394, 643, 609, 735, 461, 577, 498, 411, 522, 445, 490, 410, 425, 527, 479, 381, 431, 625, 411, 571, 343, 383, 440, 451, 482, 409, 497, 444, 395, 515, 520, 590, 568, 706, 405, 306, 342, 667, 406, 342, 505, 455, 732, 442, 568, 447, 655, 420, 383, 536, 580, 744, 487, 517, 653, 427, 504, 570, 514, 378, 415, 475, 414, 584, 461, 452, 506, 428, 536, 422, 419, 744, 366, 744, 520, 383, 492, 637, 573, 383, 725, 372, 469, 589, 517, 561, 395, 405, 685, 500, 544, 355, 616, 325, 467, 584, 526, 538, 603, 456, 595, 744, 498, 701, 533, 549, 545, 296, 459, 443, 696, 524, 446, 562, 392, 591, 489, 517, 450, 522, 488, 485, 532, 424, 444, 472, 502, 400, 485, 491, 455, 316, 615, 402, 719, 446, 328, 424, 450, 515, 461, 486, 537, 490, 447, 535, 539, 618, 432, 420, 445, 388, 457, 432, 439, 472, 512, 296]
thresholds = [356, 465, 610]
display_name = "Cumulative Trial Capacity Years Over 20 Years"
units = "years"

# Calculate exceedance probabilities (1 - CDF)
sorted_samples = np.sort(samples)
exceedance = 1 - np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot exceedance curve
ax.plot(sorted_samples, exceedance * 100, color=COLOR_BLACK, linewidth=2.5)
ax.fill_between(sorted_samples, 0, exceedance * 100, alpha=0.1, color=COLOR_BLACK)

# Apply tick formatter for readable labels (K, M, B suffixes, $ for USD)
ax.xaxis.set_major_formatter(get_tick_formatter(unit=units))

# Annotate thresholds
for thresh in thresholds:
    exceed_pct = (np.array(samples) >= thresh).sum() / len(samples) * 100
    ax.axvline(thresh, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
    ax.axhline(exceed_pct, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.3)

    # Add label with formatted threshold value (use format_parameter_value for full units)
    ax.annotate(f'{exceed_pct:.0f}% chance\nâ‰¥ {format_parameter_value(thresh, units)}',
                xy=(thresh, exceed_pct), xytext=(thresh * 1.05, exceed_pct + 5),
                fontsize=10, ha='left', weight='bold',
                bbox=dict(boxstyle='round,pad=0.3', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, alpha=0.9))

ax.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=12)
ax.set_ylabel('Probability of Exceeding Value (%)', fontsize=12)
ax.set_title(f'Exceedance Probability: {display_name}', fontsize=14, weight='bold', pad=15)
ax.set_ylim(0, 100)
ax.set_xlim(left=min(sorted_samples) * 0.95)

clean_spines(ax)
add_watermark(fig)

# Save PNG to knowledge/figures/ regardless of where Quarto renders from
output_path = get_figure_output_path('exceedance-trial_capacity_cumulative_years_20yr.png')
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Exceedance: {display_name}',
    description=f'Probability of {display_name} exceeding various thresholds'
)

plt.show()
```

*This exceedance probability chart shows the likelihood that Cumulative Trial Capacity Years Over 20 Years will exceed any given threshold. Higher curves indicate more favorable outcomes with greater certainty.*
