```{python}
#| echo: false
#| fig-cap: "Monte Carlo Distribution: Cumulative Trial Capacity Years Over 20 Years (10,000 simulations)"

import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines, get_tick_formatter,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
)
from dih_models.parameters import format_parameter_value

setup_chart_style()

# Simulation results

samples = [439, 564, 404, 390, 728, 608, 453, 492, 465, 543, 394, 402, 458, 372, 426, 544, 433, 554, 394, 468, 480, 526, 362, 477, 502, 495, 421, 434, 430, 428, 296, 500, 510, 539, 414, 372, 474, 542, 540, 411, 404, 420, 525, 445, 454, 446, 395, 445, 409, 458, 440, 413, 635, 492, 506, 522, 488, 335, 545, 388, 678, 494, 450, 416, 407, 401, 495, 505, 396, 481, 603, 579, 550, 423, 452, 408, 502, 451, 413, 491, 426, 524, 496, 498, 590, 424, 506, 463, 425, 427, 410, 473, 502, 471, 679, 634, 612, 558, 431, 549, 498, 354, 496, 405, 551, 482, 553, 494, 397, 686, 428, 444, 518, 633, 458, 512, 444, 462, 325, 485, 562, 449, 446, 348, 398, 434, 338, 589, 522, 551, 499, 621, 413, 483, 638, 560, 438, 397, 296, 296, 430, 557, 742, 442, 539, 501, 520, 476, 379, 451, 478, 564, 676, 508, 469, 310, 453, 387, 509, 588, 555, 531, 296, 540, 397, 548, 391, 432, 478, 468, 524, 427, 505, 595, 604, 449, 327, 450, 474, 440, 354, 446, 501, 374, 429, 331, 449, 595, 620, 321, 314, 480, 498, 338, 575, 548, 412, 499, 464, 478, 436, 344, 456, 412, 736, 468, 542, 594, 546, 494, 392, 612, 461, 507, 493, 385, 420, 351, 477, 528, 484, 444, 449, 571, 456, 445, 296, 302, 543, 489, 637, 518, 438, 364, 531, 524, 743, 478, 568, 512, 546, 472, 692, 637, 296, 605, 573, 304, 296, 586, 497, 436, 313, 557, 486, 402, 428, 497, 476, 621, 485, 487, 445, 514, 425, 385, 451, 435, 459, 464, 530, 438, 472, 296, 328, 432, 534, 576, 365, 442, 425, 690, 391, 427, 576, 506, 442, 460, 490, 473, 486, 451, 337, 744, 485, 449, 439, 497, 692, 437, 314, 649, 396, 493, 469, 566, 494, 354, 417, 313, 367, 428, 312, 428, 398, 490, 458, 528, 386, 587, 402, 481, 368, 404, 305, 405, 657, 470, 586, 511, 334, 412, 528, 560, 461, 593, 525, 438, 369, 415, 744, 439, 458, 430, 324, 737, 518, 416, 658, 337, 433, 397, 516, 399, 378, 444, 444, 441, 544, 477, 477, 432, 386, 567, 475, 336, 532, 540, 447, 397, 463, 351, 396, 397, 419, 296, 482, 732, 325, 505, 455, 353, 662, 599, 662, 537, 428, 421, 441, 627, 744, 459, 506, 426, 408, 452, 403, 445, 421, 529, 480, 447, 399, 499, 421, 487, 474, 398, 731, 607, 640, 744, 526, 404, 489, 447, 376, 351, 470, 349, 456, 542, 518, 640, 547, 496, 400, 314, 622, 432, 564, 425, 475, 707, 391, 519, 512, 569, 524, 429, 481, 437, 434, 352, 494, 639, 379, 493, 373, 432, 475, 435, 298, 296, 458, 450, 378, 543, 436, 466, 438, 541, 660, 738, 577, 505, 490, 299, 374, 554, 435, 500, 489, 448, 414, 494, 379, 581, 463, 296, 445, 341, 456, 417, 469, 479, 536, 429, 543, 410, 377, 434, 489, 427, 491, 390, 707, 494, 731, 642, 348, 393, 530, 644, 744, 513, 296, 428, 515, 426, 655, 490, 456, 471, 401, 435, 410, 527, 393, 323, 555, 547, 351, 481, 344, 504, 339, 453, 442, 329, 496, 552, 504, 427, 655, 412, 513, 370, 744, 537, 678, 541, 443, 480, 486, 478, 447, 559, 407, 410, 432, 419, 439, 296, 472, 491, 533, 563, 598, 547, 470, 436, 460, 535, 393, 405, 478, 524, 419, 448, 634, 470, 442, 548, 448, 635, 351, 360, 486, 434, 744, 583, 490, 569, 407, 296, 587, 542, 444, 324, 594, 443, 305, 672, 604, 502, 511, 399, 444, 696, 422, 516, 357, 521, 522, 420, 403, 427, 678, 420, 563, 444, 629, 427, 539, 605, 407, 444, 520, 339, 503, 461, 442, 520, 425, 512, 501, 348, 564, 744, 324, 296, 500, 727, 491, 489, 481, 576, 417, 421, 642, 408, 296, 449, 494, 476, 414, 687, 450, 499, 303, 479, 319, 575, 416, 437, 545, 449, 363, 493, 679, 466, 548, 494, 471, 682, 665, 424, 511, 744, 401, 441, 530, 611, 398, 435, 296, 429, 432, 479, 399, 413, 359, 511, 503, 507, 401, 335, 505, 502, 438, 486, 389, 744, 541, 536, 744, 555, 550, 482, 374, 486, 563, 469, 381, 556, 549, 418, 483, 412, 465, 408, 563, 465, 482, 593, 655, 409, 495, 561, 472, 372, 744, 643, 550, 338, 440, 403, 581, 577, 427, 459, 419, 480, 441, 451, 402, 400, 666, 744, 386, 366, 561, 713, 456, 391, 307, 422, 497, 547, 463, 490, 560, 296, 308, 371, 550, 396, 412, 428, 359, 413, 405, 412, 436, 697, 457, 514, 604, 318, 313, 348, 443, 349, 463, 447, 573, 431, 459, 608, 468, 471, 307, 393, 463, 443, 460, 482, 571, 477, 533, 599, 422, 432, 698, 475, 386, 379, 383, 461, 542, 571, 435, 433, 356, 375, 476, 598, 492, 446, 482, 516, 443, 509, 521, 438, 500, 444, 441, 580, 507, 341, 584, 741, 713, 462, 461, 474, 363, 744, 431, 329, 579, 498, 533, 547, 493, 342, 304, 494, 300, 461, 311, 472, 453, 434, 296, 396, 529, 388, 496, 508, 392, 461, 441, 463, 436, 429, 727, 410, 556, 633, 469, 457, 528, 398, 615, 500, 517, 468, 441, 559, 406, 459, 719, 729, 465, 483, 473, 466, 445, 389, 576, 586, 573, 440, 360, 503, 744, 682, 541, 514, 500, 461, 492, 381, 526, 544, 425, 650, 432, 455, 477, 326, 521, 296, 484, 604, 458, 570, 533, 431, 419, 521, 387, 369, 341, 421, 348, 717, 492, 545, 454, 516, 479, 302, 479, 430, 484, 458, 464, 427, 368, 321, 438, 416, 582, 472, 390, 395, 446, 394, 424, 364, 440, 496, 436, 744, 432, 744, 686, 427, 425, 584, 529, 347, 507, 296, 464, 430, 324, 453, 559, 474, 467, 619, 487, 532, 391, 461, 489, 473, 445, 414, 558, 565, 375, 501, 628, 427, 426, 649, 445, 405, 433, 413, 626, 436, 491, 507, 395, 337, 308, 353, 474, 435, 403, 454, 453, 398]  # Truncate for embedding
baseline = 456.0
mean = 475.0439
std = 98.3339004249806
p5 = 321.0
p50 = 465.0
p95 = 676.0
display_name = "Cumulative Trial Capacity Years Over 20 Years"
units = "years"

# Create figure with two subplots

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))
fig.subplots_adjust(wspace=0.3)

# --- Left: Histogram ---

# Handle edge case where all samples are identical (zero variance)

if std == 0 or (max(samples) == min(samples)):
    n_bins = 1
else:
    n_bins = min(50, max(1, int(np.sqrt(len(samples)))))
n, bins, patches = ax1.hist(samples, bins=n_bins, color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1)

# Apply tick formatter for readable labels (K, M, B suffixes, $ for USD)

ax1.xaxis.set_major_formatter(get_tick_formatter(unit=units))

# Mark key statistics with formatted values in legend (use format_parameter_value for full units)

ax1.axvline(p50, color=COLOR_BLACK, linestyle='--', linewidth=2, label=f'Median: {format_parameter_value(p50, units)}')
ax1.axvline(p5, color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f'5th %-ile: {format_parameter_value(p5, units)}')
ax1.axvline(p95, color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f'95th %-ile: {format_parameter_value(p95, units)}')
ax1.axvline(baseline, color=COLOR_BLACK, linestyle='-', linewidth=1.5, alpha=0.5, label=f'Baseline: {format_parameter_value(baseline, units)}')

ax1.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=11)
ax1.set_ylabel('Frequency', fontsize=11)
ax1.set_title('Distribution of Outcomes', fontsize=12, weight='bold')
ax1.legend(loc='upper right', fontsize=9)
clean_spines(ax1)

# --- Right: CDF (Cumulative Probability) ---

sorted_samples = np.sort(samples)
cumulative = np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

ax2.plot(sorted_samples, cumulative * 100, color=COLOR_BLACK, linewidth=2)
ax2.fill_between(sorted_samples, 0, cumulative * 100, alpha=0.1, color=COLOR_BLACK)

# Apply tick formatter for readable labels (K, M, B suffixes, $ for USD)

ax2.xaxis.set_major_formatter(get_tick_formatter(unit=units))

# Mark key percentiles

ax2.axhline(50, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
ax2.axhline(5, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.5)
ax2.axhline(95, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.5)
ax2.axvline(p50, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)

ax2.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=11)
ax2.set_ylabel('Cumulative Probability (%)', fontsize=11)
ax2.set_title('Probability of Exceeding Value', fontsize=12, weight='bold')
ax2.set_ylim(0, 100)
clean_spines(ax2)

# Add annotation for "probability of exceeding baseline"

exceed_baseline_pct = (np.array(samples) > baseline).sum() / len(samples) * 100
ax2.annotate(f'{exceed_baseline_pct:.0f}% chance of\nexceeding baseline',
             xy=(baseline, exceed_baseline_pct), xytext=(baseline * 1.1, exceed_baseline_pct + 10),
             fontsize=9, ha='left',
             arrowprops=dict(arrowstyle='->', color=COLOR_BLACK, lw=1))

# Main title

fig.suptitle(f'Monte Carlo Analysis: {display_name}', fontsize=14, weight='bold', y=1.02)

# Add watermark

add_watermark(fig)

# Save PNG to knowledge/figures/ regardless of where Quarto renders from

output_path = get_figure_output_path('mc-distribution-trial_capacity_cumulative_years_20yr.png')
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Monte Carlo: {display_name}',
    description=f'Monte Carlo simulation results showing uncertainty distribution for {display_name}'
)

plt.show()
```

**Simulation Results Summary: Cumulative Trial Capacity Years Over 20 Years**

| Statistic | Value |
|:----------|------:|
| Baseline (deterministic) | 456 |
| Mean (expected value) | 475 |
| Median (50th percentile) | 465 |
| Standard Deviation | 98.3 |
| 90% Confidence Interval | [321, 676] |

*The histogram shows the distribution of Cumulative Trial Capacity Years Over 20 Years across 10,000 Monte Carlo simulations. The CDF (right) shows the probability of the outcome exceeding any given value, which is useful for risk assessment.*
