```{python}
#| warning: false
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path
from dih_models.parameters import *

# --- Import centralized style ---

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, PATTERN_DIAGONAL, get_figure_output_path)

setup_chart_style()

# --- Data calculated from TOTAL one-time parameters ---

scenarios = ['Historical Rate\n(Existing Drugs Only)', 'Lag Elimination\n(PRIMARY)', 'Innovation Acceleration\n(With Cascading Effects)']

# Daily opportunity costs (TOTAL one-time benefits / lag years / 365)
# These represent the daily cost of delay during the 8.2-year efficacy lag period

money_lost = [
    float(HISTORICAL_PROGRESS_ECONOMIC_LOSS_TOTAL) / EFFICACY_LAG_YEARS / 365 / 1_000_000_000,  # Historical rate
    float(DISEASE_ERADICATION_DELAY_ECONOMIC_LOSS) / EFFICACY_LAG_YEARS / 365 / 1_000_000_000,  # PRIMARY
    float(DISEASE_ERADICATION_PLUS_ACCELERATION_ECONOMIC_LOSS_TOTAL) / EFFICACY_LAG_YEARS / 365 / 1_000_000_000  # Optimistic
]

# Daily DALYs foregone (calculated from economic loss / $150k VSLY)
# Since economic_loss = DALYs × VSLY, we can derive: DALYs = economic_loss / VSLY

qalys_lost = [
    (float(HISTORICAL_PROGRESS_ECONOMIC_LOSS_TOTAL) / EFFICACY_LAG_YEARS / 365) / STANDARD_ECONOMIC_QALY_VALUE_USD,  # Historical rate
    (float(DISEASE_ERADICATION_DELAY_ECONOMIC_LOSS) / EFFICACY_LAG_YEARS / 365) / STANDARD_ECONOMIC_QALY_VALUE_USD,  # PRIMARY
    (float(DISEASE_ERADICATION_PLUS_ACCELERATION_ECONOMIC_LOSS_TOTAL) / EFFICACY_LAG_YEARS / 365) / STANDARD_ECONOMIC_QALY_VALUE_USD  # Optimistic
]

# --- Create figure ---

fig, ax = plt.subplots(figsize=(12, 8))

x = np.arange(len(scenarios))
width = 0.7

# Create bars

bars = ax.bar(
    x,
    money_lost,
    width,
    color=COLOR_WHITE,
    edgecolor=COLOR_BLACK,
    linewidth=2.5,
    hatch=PATTERN_DIAGONAL
)

# Highlight base case with solid fill

bars[1].set_facecolor(COLOR_BLACK)
bars[1].set_hatch(None)

# --- Add value labels ---

for i, (money, qaly) in enumerate(zip(money_lost, qalys_lost)):
    # Money label - first bar (smallest) gets label above, others inside
    if i == 0:
        # Position above bar for smallest column
        ax.text(
            i, money + max(money_lost)*0.02,
            f'${money:.0f}B/day',
            ha='center', va='bottom',
            fontsize=24, fontweight='bold',
            color=COLOR_BLACK,
            bbox=dict(boxstyle='round,pad=0.4', facecolor=COLOR_WHITE,
                      edgecolor=COLOR_BLACK, linewidth=2)
        )
    else:
        # Position inside bar for larger columns
        text_color = COLOR_WHITE if i == 1 else COLOR_BLACK
        ax.text(
            i, money/2,
            f'${money:.0f}B/day',
            ha='center', va='center',
            fontsize=28, fontweight='bold',
            color=text_color,
            bbox=dict(boxstyle='round,pad=0.5', facecolor=COLOR_WHITE if i != 1 else COLOR_BLACK,
                      edgecolor=COLOR_BLACK, linewidth=2)
        )

    # DALY label ABOVE bar - extra spacing for first bar since money label is also above
    daly_offset = max(money_lost)*0.12 if i == 0 else max(money_lost)*0.05
    ax.text(
        i, money + daly_offset,
        f'{qaly/1_000_000:.1f}M\nDALYs/day',
        ha='center', va='bottom',
        fontsize=20, fontweight='bold',
        color=COLOR_BLACK
    )

# --- Add calculation explanation (upper left) ---

equation_text = (
    f'Historical Rate: {float(HISTORICAL_PROGRESS_DEATHS_ANNUAL)/1e6:.0f}M deaths/yr × {EFFICACY_LAG_YEARS}yr / 365 = ${money_lost[0]:.0f}B/day\n'
    f'Lag Elimination (PRIMARY): {float(DISEASE_ERADICATION_DELAY_DEATHS_ANNUAL)/1e6:.0f}M deaths/yr × {EFFICACY_LAG_YEARS}yr / 365 = ${money_lost[1]:.0f}B/day\n'
    f'Innovation Acceleration: {float(DISEASE_ERADICATION_PLUS_ACCELERATION_DEATHS_ANNUAL)/1e6:.0f}M deaths/yr × {EFFICACY_LAG_YEARS}yr / 365 = ${money_lost[2]:.0f}B/day'
)

ax.text(
    0.02, 0.98,
    equation_text,
    transform=ax.transAxes,
    fontsize=14,
    verticalalignment='top',
    bbox=dict(boxstyle='round,pad=0.8', facecolor=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1.5),
    family='monospace'
)

# --- Styling ---

ax.set_title(
    'Daily Cost of the 8-Year Post-Safety Efficacy Lag',
    fontsize=36, fontweight='bold',
    color=COLOR_BLACK, pad=25
)

ax.set_ylabel(
    'Economic Waste Per Day',
    fontsize=28, fontweight='bold',
    color=COLOR_BLACK, labelpad=15
)

ax.set_xticks(x)
ax.set_xticklabels(scenarios, fontsize=22, fontweight='bold')

# Set y-axis limits - extra space at top for QALY labels

ax.set_ylim(0, max(money_lost) * 1.35)

# Remove y-axis (data is labeled)

ax.set_yticks([])
ax.spines['left'].set_visible(False)

# Clean up chart

clean_spines(ax)
ax.spines['bottom'].set_linewidth(2.5)
ax.tick_params(axis='x', length=0)

# Add source note at bottom

ax.text(
    0.5, -0.15,
    'Sources: WHO Global Disease Burden (150K deaths/day), BIO Clinical Development Report (8.2yr lag), VSLY=$150k',
    transform=ax.transAxes,
    fontsize=10,
    ha='center',
    va='top',
    color=COLOR_BLACK,
    style='italic'
)

# Add watermark

add_watermark(fig)

# --- Save figure ---

output_path = get_figure_output_path('dfda-daily-opportunity-cost-column-chart.png')

plt.savefig(output_path, dpi=200, bbox_inches=None, facecolor=COLOR_WHITE)

# Add metadata

from dih_models.plotting.chart_style import add_png_metadata, get_figure_output_path
add_png_metadata(
    output_path,
    title="Daily Cost of the 8-Year Post-Safety Efficacy Lag",
    description=f"PRIMARY: 55M deaths/yr → 993M DALYs × $150k = ${money_lost[1]:.0f}B/day. Ranges from ${money_lost[0]:.0f}B/day (conservative: 12M deaths) to ${money_lost[2]:.0f}B/day (optimistic: 110M deaths)"
)

plt.show()
```
