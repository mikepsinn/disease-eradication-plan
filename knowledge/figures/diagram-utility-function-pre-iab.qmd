```{python}
#| label: fig-utility-pre-iab
#| fig-cap: "PRE-IAB: Rankings Ignored. NSV rankings exist but don't affect politician utility, which is driven by lobbying intensity from concentrated interests."
#| fig-alt: "Flow diagram showing that before IABs, NSV rankings are ignored and politician utility is driven by campaign funding, revolving door incentives, and partisan loyalty rather than social welfare."
#| warning: false

import graphviz
from pathlib import Path
from dih_models.plotting.graphviz_helper import setup_graphviz_style, render_graphviz_with_watermark

# Create the diagram
dot = graphviz.Digraph(comment='Pre-IAB Utility Function', format='png')

# Set graph attributes for compact layout
dot.attr(rankdir='TB', size='10,8', nodesep='0.5', ranksep='0.6', dpi='200')
dot.attr('node', fontsize='13', fontname='Helvetica', margin='0.3,0.2')
dot.attr('edge', fontsize='12', fontname='Helvetica')

# Apply standard styling
setup_graphviz_style(dot)

# Helper for boxed labels
def boxed_label(text, size='12'):
    """Wrap label in HTML-like table for white background with border."""
    # First, temporarily replace <BR/> with a placeholder
    text = text.replace('<BR/>', '<<<LINEBREAK>>>')
    # Escape ampersands first (before adding &lt; &gt;)
    text = text.replace('&', '&amp;')
    # Escape angle brackets in mathematical expressions
    text = text.replace('<', '&lt;').replace('>', '&gt;')
    # Restore <BR/> tags
    text = text.replace('<<<LINEBREAK>>>', '<BR/>')
    return f'<<TABLE BORDER="1" CELLBORDER="0" CELLSPACING="0" CELLPADDING="6" BGCOLOR="white"><TR><TD><FONT FACE="Helvetica" POINT-SIZE="{size}">{text}</FONT></TD></TR></TABLE>>'

def node_label(text, size='13'):
    """Wrap node label in HTML font tag for clean rendering."""
    # Escape ampersands first, then convert newlines to HTML line breaks
    html_text = text.replace('&', '&amp;').replace('\n', '<BR/>')
    return f'<<FONT FACE="Helvetica" POINT-SIZE="{size}">{html_text}</FONT>>'

# Title
dot.node('title', node_label('PRE-IAB: Rankings Ignored', '16'),
         shape='plaintext', fontsize='16', style='bold')

# NSV Ranking exists but is ignored
dot.node('ranking', node_label('NSV Ranking R\n(Copenhagen Consensus,\nGiveWell, IMF)'),
         shape='box', style='dashed', penwidth='2')
dot.node('ignored', node_label('IGNORED', '14'), shape='plaintext',
         fontsize='14', fontcolor='gray')

# Individual components
dot.node('P', node_label('Pi (Reelection)\nDriven by:\n- Campaign Funding\n- Attack ads avoided'),
         shape='box')
dot.node('Y', node_label('Yi (Post-Office)\nDriven by:\n- Revolving door\n- Industry ties'),
         shape='box')
dot.node('S', node_label('Si (Legacy)\nDriven by:\n- Partisan loyalty\n- Donor satisfaction'),
         shape='box')

# Utility components driven by lobbying
dot.node('utility', node_label('Ui = ai*Pi + bi*Yi + gi*Si'),
         shape='box', style='bold', penwidth='2.5')

# Action outcome
dot.node('action', node_label('ai = 0\n(Oppose Public Good)'),
         shape='box', style='filled', fillcolor='lightgray')

# Edges
dot.edge('title', 'ranking', style='invis')
dot.edge('ranking', 'ignored', style='dashed', color='gray')
dot.edge('P', 'utility')
dot.edge('Y', 'utility')
dot.edge('S', 'utility')
dot.edge('utility', 'action', label=boxed_label('Change in Ui = benefit - cost < 0'))

# Layout organization
with dot.subgraph() as s:
    s.attr(rank='same')
    s.node('P')
    s.node('Y')
    s.node('S')

# Render the diagram
png_path = render_graphviz_with_watermark(dot, 'utility-function-pre-iab')
print(f"Generated: {png_path}")
```

**Before IABs:** Politicians maximize utility based on lobbying intensity. The NSV ranking exists but doesn't affect their utility function, so they have no incentive to support high-NSV programs.
