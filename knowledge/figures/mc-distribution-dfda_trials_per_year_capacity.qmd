```{python}
#| echo: false
#| fig-cap: "Monte Carlo Distribution: dFDA Maximum Trials per Year (10,000 simulations)"
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

from dih_models.plotting.chart_style import (
    setup_chart_style, add_watermark, clean_spines,
    COLOR_BLACK, COLOR_WHITE, add_png_metadata, get_figure_output_path
)

setup_chart_style()

# Simulation results
samples = [83657, 93833, 80621, 79359, 110313, 98439, 84894, 88078, 85918, 92087, 79763, 80438, 85330, 77199, 82535, 92135, 83214, 92899, 79769, 86154, 87124, 90782, 75865, 86905, 88901, 88341, 82093, 83237, 82911, 82787, 66040, 88739, 89521, 91788, 81525, 77175, 86613, 91989, 91869, 81291, 80669, 82019, 90666, 84162, 84972, 84256, 79816, 84222, 81101, 85319, 83766, 81422, 101268, 88103, 89211, 90466, 87779, 72178, 92185, 79177, 105533, 88215, 84648, 81727, 80884, 80334, 88316, 89152, 79905, 87170, 97964, 95447, 92596, 82333, 84791, 81023, 88893, 84678, 81460, 88028, 82609, 90639, 88421, 88558, 96545, 82402, 89204, 85710, 82445, 82679, 81192, 86502, 88864, 86367, 105619, 101082, 98809, 93195, 83000, 92489, 88532, 74808, 88371, 80707, 92705, 87273, 92831, 88245, 80022, 106393, 82762, 84123, 90132, 101063, 85287, 89650, 84159, 85643, 70781, 87518, 93550, 84532, 84247, 73992, 80057, 83296, 72597, 96420, 90473, 92650, 88617, 99789, 81396, 87394, 101521, 93415, 83596, 80037, 66041, 66040, 82900, 93135, 110420, 83914, 91782, 88805, 90266, 86806, 78069, 84688, 86935, 93759, 105375, 89329, 86182, 68662, 84876, 79082, 89425, 96352, 92947, 91116, 66040, 91846, 80034, 92469, 79419, 83102, 86920, 86089, 90586, 82682, 89097, 97071, 98004, 84579, 71075, 84667, 86647, 83788, 74716, 84251, 88773, 77495, 82801, 71641, 84504, 97051, 99634, 70147, 69220, 87085, 88569, 72621, 94990, 92406, 81340, 88652, 85835, 86969, 83430, 73342, 85156, 81336, 110372, 86146, 92012, 96951, 92279, 88209, 79522, 98876, 85581, 89313, 88162, 78951, 82053, 74288, 86905, 90896, 87406, 84090, 84551, 94598, 85157, 84190, 66040, 67355, 92089, 87868, 101384, 90106, 83582, 76097, 91146, 90581, 110493, 86964, 94218, 89649, 92269, 86472, 106986, 101451, 66040, 98174, 94812, 67801, 66040, 96117, 88459, 83402, 69156, 93115, 87561, 80441, 82760, 88517, 86756, 99757, 87510, 87715, 84162, 89842, 82508, 78833, 84699, 83332, 85421, 85798, 91089, 83576, 86493, 66041, 71150, 83096, 91403, 95083, 76302, 83949, 82449, 106729, 79446, 82625, 95049, 89220, 83942, 85426, 87903, 86538, 87610, 84720, 72488, 110568, 87500, 84552, 83718, 88486, 106966, 83496, 69173, 102698, 79866, 88168, 86236, 94055, 88211, 74797, 81751, 69110, 76494, 82730, 68964, 82731, 80104, 87935, 85326, 90907, 79037, 96236, 80408, 87166, 76580, 80618, 68003, 80753, 103417, 86276, 96125, 89566, 71963, 81379, 90918, 93383, 85565, 96911, 90709, 83607, 76804, 81574, 110567, 83660, 85287, 82903, 70594, 110379, 90109, 81695, 103598, 72429, 83217, 79981, 89958, 80199, 78033, 84157, 84147, 83896, 92166, 86855, 86890, 83113, 78970, 94152, 86692, 72356, 91255, 91852, 84371, 79995, 85717, 74403, 79913, 80012, 81945, 66040, 87271, 110344, 70749, 89117, 85034, 74667, 103990, 97534, 103971, 91639, 82726, 82148, 83855, 100450, 110567, 85412, 89222, 82591, 80946, 84820, 80556, 84183, 82108, 90961, 87086, 84410, 80154, 88646, 82169, 87711, 86639, 80094, 110338, 98337, 101732, 110567, 90762, 80628, 87849, 84402, 77738, 74420, 86292, 74068, 85145, 91968, 90133, 101702, 92356, 88384, 80266, 69256, 99890, 83048, 93842, 82486, 86736, 108426, 79440, 90213, 89682, 94345, 90582, 82807, 87156, 83491, 83261, 74516, 88272, 101633, 78051, 88190, 77378, 83113, 86737, 83352, 66473, 66041, 85306, 84666, 77923, 92031, 83461, 85983, 83593, 91937, 103749, 110385, 95170, 89125, 87910, 66636, 77500, 92924, 83359, 88744, 87846, 84490, 81504, 88246, 78099, 95598, 85753, 66040, 84226, 72997, 85150, 81764, 86203, 87019, 91527, 82790, 92076, 81190, 77794, 83229, 87859, 82628, 88023, 79392, 108436, 88220, 110336, 101972, 73929, 79659, 91073, 102111, 110568, 89754, 66040, 82759, 89873, 82552, 103208, 87940, 85093, 86413, 80351, 83381, 81172, 90838, 79641, 70430, 92986, 92352, 74310, 87171, 73391, 89005, 72706, 84868, 83980, 71262, 88411, 92762, 89050, 82639, 103298, 81380, 89719, 76909, 110567, 91581, 105602, 91883, 84054, 87083, 87620, 86939, 84363, 93295, 80913, 81210, 83102, 81928, 83715, 66041, 86420, 88011, 91331, 93700, 97407, 92361, 86303, 83452, 85435, 91422, 79626, 80695, 86942, 90572, 81983, 84471, 101101, 86283, 83954, 92444, 84458, 101225, 74304, 75513, 87614, 83251, 110567, 95850, 87914, 94386, 80862, 66041, 96206, 91968, 84139, 70660, 97014, 84044, 67994, 104935, 98060, 88866, 89583, 80206, 84096, 107323, 82208, 90007, 75148, 90382, 90449, 82033, 80537, 82668, 105585, 82054, 93735, 84140, 100651, 82680, 91733, 98088, 80866, 84096, 90280, 72758, 88992, 85570, 83906, 90322, 82510, 89679, 88778, 73946, 93843, 110567, 70662, 66040, 88731, 110304, 88036, 87859, 87160, 95100, 81772, 82146, 101960, 80964, 66041, 84583, 88232, 86815, 81530, 106459, 84637, 88622, 67703, 87047, 69930, 94933, 81720, 83555, 92210, 84545, 76004, 88133, 105708, 85923, 92465, 88269, 86381, 105973, 104245, 82436, 89599, 110568, 80391, 83882, 91031, 98703, 80052, 83348, 66040, 82860, 83083, 86994, 80179, 81464, 75461, 89589, 88953, 89276, 80351, 72132, 89126, 88875, 83592, 87565, 79284, 110567, 91886, 91550, 110567, 92936, 92563, 87241, 77401, 87560, 93676, 86205, 78309, 93031, 92528, 81914, 87389, 81312, 85896, 80948, 93749, 85884, 87311, 96899, 103255, 81055, 88332, 93530, 86485, 77188, 110567, 102001, 92622, 72625, 83811, 80508, 95567, 95207, 82670, 85385, 81981, 87144, 83842, 84681, 80438, 80243, 104325, 110567, 78958, 76350, 93501, 109001, 85097, 79423, 68290, 82202, 88484, 92394, 85717, 87954, 93406, 66041, 68445, 77075, 92606, 79925, 81365, 82706, 75490, 81394, 80691, 81384, 83407, 107493, 85205, 89848, 98038, 69752, 69152, 73992, 84001, 74108, 85713, 84367, 94755, 83019, 85370, 98448, 86163, 86368, 68290, 79665, 85717, 84046, 85484, 87254, 94564, 86880, 91274, 97511, 82237, 83059, 107554, 86676, 78997, 78165, 78644, 85522, 92026, 94586, 83381, 83141, 74971, 77585, 86744, 97402, 88099, 84266, 87248, 90010, 84018, 89460, 90385, 83611, 88707, 84079, 83876, 95554, 89292, 72936, 95951, 110411, 109041, 85591, 85579, 86639, 75981, 110568, 83027, 71305, 95351, 88544, 91326, 92403, 88151, 73074, 67795, 88222, 67018, 85546, 68841, 86465, 84871, 83237, 66040, 79949, 90981, 79172, 88412, 89355, 79570, 85577, 83839, 85699, 83436, 82827, 110304, 81184, 93077, 100993, 86215, 85203, 90877, 80084, 99162, 88743, 90062, 86130, 83837, 93284, 80796, 85351, 109642, 110317, 85886, 87385, 86537, 85998, 84208, 79313, 95061, 96124, 94752, 83767, 75555, 88923, 110568, 105941, 91935, 89860, 88754, 85524, 88045, 78307, 90745, 92158, 82458, 102731, 83070, 85072, 86854, 70956, 90341, 66041, 87417, 97988, 85302, 94457, 91317, 83019, 81935, 90341, 79052, 76773, 72956, 82113, 73935, 109419, 88090, 92194, 84954, 89962, 86989, 67291, 87014, 82904, 87467, 85261, 85756, 82667, 76663, 70192, 83623, 81704, 95754, 86426, 79361, 79852, 84306, 79717, 82376, 76174, 83764, 88367, 83442, 110568, 83117, 110568, 106318, 82643, 82467, 95957, 91017, 73839, 89312, 66040, 85812, 82943, 70585, 84871, 93234, 86583, 86052, 99572, 87638, 91245, 79466, 85552, 87834, 86557, 84225, 81519, 93214, 93860, 77518, 88783, 100524, 82698, 82564, 102639, 84181, 80720, 83175, 81417, 100294, 83475, 87979, 89303, 79822, 72385, 68330, 74595, 86583, 83325, 80511, 84940, 84873, 80132]  # Truncate for embedding
baseline = 84834.0
mean = 86365.1499
std = 9287.034270327098
p5 = 70251.95
p50 = 85892.5
p95 = 105363.59999999999
display_name = "dFDA Maximum Trials per Year"
units = "trials/year"

# Create figure with two subplots
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))
fig.subplots_adjust(wspace=0.3)

# --- Left: Histogram ---
# Handle edge case where all samples are identical (zero variance)
if std == 0 or (max(samples) == min(samples)):
    n_bins = 1
else:
    n_bins = min(50, max(1, int(np.sqrt(len(samples)))))
n, bins, patches = ax1.hist(samples, bins=n_bins, color=COLOR_WHITE, edgecolor=COLOR_BLACK, linewidth=1)

# Mark key statistics
ax1.axvline(p50, color=COLOR_BLACK, linestyle='--', linewidth=2, label=f'Median: {p50:,.2g}')
ax1.axvline(p5, color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f'5th %-ile: {p5:,.2g}')
ax1.axvline(p95, color=COLOR_BLACK, linestyle=':', linewidth=1.5, alpha=0.7, label=f'95th %-ile: {p95:,.2g}')
ax1.axvline(baseline, color=COLOR_BLACK, linestyle='-', linewidth=1.5, alpha=0.5, label=f'Baseline: {baseline:,.2g}')

ax1.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=11)
ax1.set_ylabel('Frequency', fontsize=11)
ax1.set_title('Distribution of Outcomes', fontsize=12, weight='bold')
ax1.legend(loc='upper right', fontsize=9)
clean_spines(ax1)

# --- Right: CDF (Cumulative Probability) ---
sorted_samples = np.sort(samples)
cumulative = np.arange(1, len(sorted_samples) + 1) / len(sorted_samples)

ax2.plot(sorted_samples, cumulative * 100, color=COLOR_BLACK, linewidth=2)
ax2.fill_between(sorted_samples, 0, cumulative * 100, alpha=0.1, color=COLOR_BLACK)

# Mark key percentiles
ax2.axhline(50, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)
ax2.axhline(5, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.5)
ax2.axhline(95, color=COLOR_BLACK, linestyle=':', linewidth=1, alpha=0.5)
ax2.axvline(p50, color=COLOR_BLACK, linestyle='--', linewidth=1, alpha=0.5)

ax2.set_xlabel(f'{display_name} ({units})' if units else display_name, fontsize=11)
ax2.set_ylabel('Cumulative Probability (%)', fontsize=11)
ax2.set_title('Probability of Exceeding Value', fontsize=12, weight='bold')
ax2.set_ylim(0, 100)
clean_spines(ax2)

# Add annotation for "probability of exceeding baseline"
exceed_baseline_pct = (np.array(samples) > baseline).sum() / len(samples) * 100
ax2.annotate(f'{exceed_baseline_pct:.0f}% chance of\nexceeding baseline',
             xy=(baseline, exceed_baseline_pct), xytext=(baseline * 1.1, exceed_baseline_pct + 10),
             fontsize=9, ha='left',
             arrowprops=dict(arrowstyle='->', color=COLOR_BLACK, lw=1))

# Main title
fig.suptitle(f'Monte Carlo Analysis: {display_name}', fontsize=14, weight='bold', y=1.02)

# Add watermark
add_watermark(fig)

# Save PNG to knowledge/figures/ regardless of where Quarto renders from
output_path = get_figure_output_path('mc-distribution-dfda_trials_per_year_capacity.png')
plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor=COLOR_WHITE)

add_png_metadata(
    output_path,
    title=f'Monte Carlo: {display_name}',
    description=f'Monte Carlo simulation results showing uncertainty distribution for {display_name}'
)

plt.show()
```

**Key Statistics:**

| Statistic | Value |
|:----------|------:|
| Baseline (deterministic) | 8.483e+04 |
| Mean (expected value) | 8.637e+04 |
| Median (50th percentile) | 8.589e+04 |
| Standard Deviation | 9,287 |
| 90% Confidence Interval | [7.025e+04, 1.054e+05] |

*The histogram shows the distribution of dFDA Maximum Trials per Year across 10,000 Monte Carlo simulations. The CDF (right) shows the probability of the outcome exceeding any given value, which is useful for risk assessment.*
