---
title: "DIH Financial Plan: Budget vs. Actuals"
format: html
---

```{python}
#| echo: false
#| message: false

import os
from dotenv import load_dotenv
from pyairtable import Api
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd

# --- Configuration ---
load_dotenv()
AIRTABLE_API_KEY = os.getenv("AIRTABLE_API_KEY")
AIRTABLE_BASE_ID = os.getenv("AIRTABLE_BASE_ID")
DELIVERABLES_TABLE_ID = os.getenv("DELIVERABLES_TABLE_ID")
TRANSACTIONS_TABLE_ID = os.getenv("TRANSACTIONS_TABLE_ID")

# --- Helper Functions ---
def fetch_data(api, base_id, table_id, required_fields=[]):
    """Fetches all records from a table and returns a list of dictionaries."""
    if not all([AIRTABLE_API_KEY, base_id, table_id]):
        print(f"ERROR: Airtable environment variables are missing for table {table_id}. Please check your .env file.")
        return []
    try:
        table = api.table(base_id, table_id)
        return table.all()
    except Exception as e:
        print(f"ERROR: Could not fetch data from Airtable table {table_id}. Details: {e}")
        return []

# --- Data Fetching & Validation ---
api = Api(AIRTABLE_API_KEY)

# Fetch Deliverables (The Plan)
deliverable_records = fetch_data(api, AIRTABLE_BASE_ID, DELIVERABLES_TABLE_ID)
deliverable_data = [
    record["fields"] for record in deliverable_records
]
if not deliverable_data:
    print("WARNING: No data found in the 'Deliverables' table.")
    plan_df = pd.DataFrame()
else:
    plan_df = pd.DataFrame(deliverable_data)

# Fetch Transactions (The Reality)
transaction_records = fetch_data(api, AIRTABLE_BASE_ID, TRANSACTIONS_TABLE_ID)
transaction_data = [
    record["fields"] for record in transaction_records
]
if not transaction_data:
    print("WARNING: No data found in the 'Transactions' table.")
    actual_df = pd.DataFrame()
else:
    actual_df = pd.DataFrame(transaction_data)


# --- Data Processing ---
# Process Deliverables for Gantt Chart
if not plan_df.empty and 'Start Date' in plan_df.columns and 'Due Date' in plan_df.columns:
    plan_df = plan_df.rename(columns={"Deliverable Name": "Task", "Start Date": "Start", "Due Date": "Finish"})
    plan_df = plan_df.dropna(subset=['Start', 'Finish'])
    if not plan_df.empty:
        plan_df['Start'] = pd.to_datetime(plan_df['Start'])
        plan_df['Finish'] = pd.to_datetime(plan_df['Finish'])
else:
    print("WARNING: Could not generate Gantt chart. 'Deliverables' table is missing data or 'Start Date'/'Due Date' columns.")
    plan_df = pd.DataFrame() # Ensure it's empty if invalid

# Process Transactions for Treasury Chart
if not actual_df.empty and 'Date' in actual_df.columns and 'Amount' in actual_df.columns:
    actual_df = actual_df.dropna(subset=['Date'])
    actual_df['Date'] = pd.to_datetime(actual_df['Date'])
    actual_df = actual_df.sort_values(by="Date")
    actual_df['Signed Amount'] = actual_df.apply(lambda row: row.get('Amount', 0) if row.get('Type') == 'Inflow' else -row.get('Amount', 0), axis=1)
    actual_df['Balance'] = actual_df['Signed Amount'].cumsum()
else:
    print("WARNING: Could not generate Treasury chart. 'Transactions' table is missing data.")
    actual_df = pd.DataFrame()

# Process Budget vs. Actuals
budget_df = pd.DataFrame()
if not plan_df.empty and 'Budgeted Cost' in plan_df.columns and 'Expected Income' in plan_df.columns:
    budget_events = []
    for index, row in plan_df.iterrows():
        if row.get('Budgeted Cost', 0) > 0:
            budget_events.append({'Date': row['Finish'], 'Amount': -row['Budgeted Cost']})
        if row.get('Expected Income', 0) > 0:
            budget_events.append({'Date': row['Finish'], 'Amount': row['Expected Income']})
    if budget_events:
        budget_df = pd.DataFrame(budget_events).sort_values(by="Date")
        budget_df['Balance'] = budget_df['Amount'].cumsum()

# --- Visualization ---
fig = make_subplots(
    rows=2, cols=1, shared_xaxes=True, vertical_spacing=0.1,
    subplot_titles=("Project Timeline (Gantt Chart)", "Financial Runway: Budget vs. Actuals")
)

# Gantt Chart
if not plan_df.empty:
    for index, row in plan_df.iterrows():
        fig.add_trace(go.Bar(x=[row['Finish'] - row['Start']], y=[row['Task']], base=[row['Start']], orientation='h', name=row['Task']), row=1, col=1)

# Budget (Planned) Runway
if not budget_df.empty:
    fig.add_trace(go.Scatter(x=budget_df['Date'], y=budget_df['Balance'], mode='lines', name='Planned Budget', line=dict(shape='spline', dash='dot')), row=2, col=1)

# Actual (Real-Time) Runway
if not actual_df.empty:
    fig.add_trace(go.Scatter(x=actual_df['Date'], y=actual_df['Balance'], mode='lines+markers', name='Actual Treasury'), row=2, col=1)

# --- Layout & Formatting ---
fig.update_layout(title_text="DIH Strategic Financial Plan", height=800, showlegend=True, yaxis_title="Deliverables", yaxis2_title="Treasury Balance ($)")
fig.update_yaxes(autorange="reversed", row=1, col=1)

# --- Output ---
# Display tables for debugging
if not budget_df.empty:
    print("\\n## Planned Budget Trajectory")
    print(budget_df.to_markdown(index=False))
if not actual_df.empty:
    print("\\n## Actual Treasury Transactions")
    print(actual_df.to_markdown(index=False))

fig.show()
fig.write_html("dih_budget_vs_actuals.html")
print("\\nInteractive 'Budget vs. Actuals' chart saved to dih_budget_vs_actuals.html")
```

### Instructions
1.  **Populate your data:**
    *   In the `Deliverables` table, ensure you have at least one record with a "Start Date" and "Due Date".
    *   In the `Transactions` table, ensure you have at least one transaction with a "Date".
2.  **Render the Chart:** Run `quarto render gantt_chart.qmd`. The script will now run without errors and will provide helpful warnings if data is missing.
